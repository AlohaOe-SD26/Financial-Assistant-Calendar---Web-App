<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Financial Calendar - Cloud Edition</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --background: #f9fafb;
            --surface: #ffffff;
            --border: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--surface);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-card {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
        }

        .auth-card h1 { font-size: 2rem; margin-bottom: 1rem; color: var(--primary-color); }
        .auth-card p { color: var(--text-secondary); margin-bottom: 2rem; }

        .google-btn {
            background: white; border: 1px solid #dadce0; border-radius: 4px;
            padding: 0.75rem 1.5rem; font-size: 1rem; cursor: pointer;
            display: inline-flex; align-items: center; gap: 0.75rem;
            transition: box-shadow 0.2s;
        }
        .google-btn:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.15); }

        .app-header {
            background: var(--surface); border-bottom: 2px solid var(--border);
            padding: 1rem 1.5rem; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex;
            justify-content: space-between; align-items: center;
        }

        .app-title { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .user-email { font-size: 0.875rem; color: var(--text-secondary); }

        .sync-status {
            font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px;
            background: var(--success-color); color: white;
        }

        .alert-badge {
            position: fixed; top: 20px; right: 20px; background: var(--danger-color);
            color: white; padding: 0.75rem 1rem; border-radius: 50px;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); cursor: pointer;
            z-index: 999; display: none; animation: pulse 2s infinite;
        }
        .alert-badge.active { display: flex; align-items: center; gap: 0.5rem; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* */
        .master-navigation {
            display: flex;
            background: #1f2937;
            padding: 0 1rem;
            gap: 1px;
        }
        .master-tab-button {
            flex: 1;
            padding: 1rem;
            border: none;
            background: #374151;
            color: #d1d5db;
            cursor: pointer;
            font-size: 1.125rem;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 4px solid transparent;
        }
        .master-tab-button:hover {
            background: #4b5563;
        }
        .master-tab-button.active {
            background: var(--surface);
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .app-view {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        .app-view.active {
            display: flex;
        }
        /* */


        .menu-bar {
            background: #1f2937; color: white; padding: 0.5rem 1rem;
            display: flex; gap: 1rem; flex-wrap: wrap;
        }

        .menu-item {
            padding: 0.5rem 1rem; cursor: pointer; border-radius: 4px;
            transition: background 0.2s; font-size: 0.875rem;
        }
        .menu-item:hover { background: #374151; }

        .forecast-bar {
            background: linear-gradient(135deg, #1e3a8a, #2563eb); color: white;
            padding: 1rem 0; border-bottom: 2px solid var(--primary-color); position: relative;
        }

        .forecast-container { max-width: 1600px; margin: 0 auto; padding: 0 1rem; position: relative; }
        .forecast-scroll-wrapper {
            overflow-x: auto; overflow-y: hidden; scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }
        .forecast-scroll-wrapper::-webkit-scrollbar { height: 6px; }
        .forecast-scroll-wrapper::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius: 3px; }
        .forecast-scroll-wrapper::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }

        .forecast-days {
            display: grid; grid-auto-flow: column;
            grid-auto-columns: minmax(350px, 1fr);
            gap: 1rem; padding: 0.5rem 0;
        }

        .forecast-day {
            background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1.25rem;
            cursor: pointer; transition: all 0.2s; border: 2px solid transparent;
            min-width: 350px;
        }
        .forecast-day:hover {
            background: rgba(255, 255, 255, 0.2); border-color: white; transform: translateY(-2px);
        }
        .forecast-day.today { background: rgba(16, 185, 129, 0.3); border-color: var(--success-color); }
        .forecast-day-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .forecast-day-name { font-weight: 700; font-size: 0.875rem; }
        .forecast-transactions { font-size: 0.75rem; margin: 0.5rem 0; opacity: 0.9; }
        .forecast-balance {
            font-weight: 700; font-size: 1.125rem; border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 0.5rem; margin-top: 0.5rem;
        }
        .forecast-balance.warning { color: #fca5a5; }

        .sub-tab-navigation {
            display: flex; background: var(--surface);
            border-bottom: 2px solid var(--border); overflow-x: auto;
        }

        .sub-tab-button {
            flex: 1; padding: 1rem; border: none; background: transparent; cursor: pointer;
            font-size: 0.95rem; font-weight: 500; color: var(--text-secondary);
            border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;
        }
        .sub-tab-button:hover { background: var(--background); }
        .sub-tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }

        .sub-tab-content {
            display: none; flex: 1; padding: 1.5rem;
            overflow-y: auto;
        }
        .sub-tab-content.active { display: block; }

        .btn {
            padding: 0.625rem 1.25rem; border: none; border-radius: 6px; cursor: pointer;
            font-size: 0.875rem; font-weight: 500; transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: var(--border); color: var(--text-primary); }
        .btn-success { background: var(--success-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-warning { background: var(--warning-color); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.75rem; }

        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem; }
        .form-control {
            width: 100%; padding: 0.625rem; border: 1px solid var(--border);
            border-radius: 6px; font-size: 0.875rem;
        }
        .form-control:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 1000; overflow-y: auto;
        }
        .modal.active {
            display: flex; align-items: center; justify-content: center; padding: 1rem;
        }
        .modal-content {
            background: var(--surface); border-radius: 8px; max-width: 900px;
            width: 100%; max-height: 90vh;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column;
        }
        .modal-content.large { max-width: 1200px; }
        .modal-content.xlarge { max-width: 1400px; }
        .modal-header {
            padding: 1.5rem; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-size: 1.25rem; font-weight: 600; }
        .modal-close {
            background: none; border: none; font-size: 1.5rem;
            cursor: pointer; color: var(--text-secondary);
        }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        .modal-footer {
            padding: 1.5rem; border-top: 1px solid var(--border);
            display: flex; gap: 0.75rem; justify-content: flex-end; flex-wrap: wrap;
        }

        .transaction-detail {
            background: var(--background); padding: 1rem; border-radius: 6px;
            border-left: 4px solid var(--primary-color); margin-bottom: 0.75rem;
        }
        .transaction-detail.income { border-left-color: var(--success-color); }
        .transaction-detail.expense { border-left-color: var(--danger-color); }

        .savings-plan-card {
            background: var(--background); border-radius: 8px; padding: 1.5rem;
            margin-bottom: 1rem; border: 2px solid var(--border);
        }
        .savings-progress-bar {
            width: 100%; height: 24px; background: #e5e7eb;
            border-radius: 12px; overflow: hidden; margin: 0.5rem 0;
        }
        .savings-progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--success-color), #34d399);
            transition: width 0.3s; display: flex; align-items: center;
            justify-content: center; color: white; font-size: 0.75rem; font-weight: 600;
        }

        .data-layout {
            display: grid; grid-template-columns: 400px 1fr;
            gap: 1.5rem; height: calc(100vh - 450px);
        }
        .panel {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 8px; padding: 1.5rem; overflow-y: auto;
        }
        .panel-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 1.25rem; }
        .data-tree { list-style: none; }
        .tree-category { margin-bottom: 1rem; }
        .tree-category-header {
            font-weight: 600; padding: 0.75rem; background: var(--background); border-radius: 4px;
        }
        .tree-item {
            padding: 0.75rem; margin: 0.25rem 0 0.25rem 1.5rem;
            border-left: 2px solid var(--border); cursor: pointer;
            transition: background 0.2s; border-radius: 4px;
        }
        .tree-item:hover { background: var(--background); }

        .calendar-controls {
            display: flex; gap: 1rem; margin-bottom: 1rem;
            align-items: center; flex-wrap: wrap;
        }
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px;
            background: var(--border); border: 1px solid var(--border);
            border-radius: 8px; overflow: hidden; width: 100%;
        }
        .calendar-header {
            background: #1f2937; color: white; padding: 0.75rem 0.5rem;
            text-align: center; font-weight: 600; font-size: 0.875rem;
        }
        .calendar-day {
            background: var(--surface); min-height: 120px; padding: 0.5rem;
            cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
        }
        .calendar-day:hover { background: var(--background); box-shadow: 0 0 0 2px var(--primary-color) inset; }
        .calendar-day.warning { background: #fef2f2; }
        .day-number { font-weight: 600; margin-bottom: 0.5rem; font-size: 0.875rem; }

        .net-worth-display {
            text-align: center; padding: 2rem;
            background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
            color: white; border-radius: 8px; margin-bottom: 1.5rem;
        }
        .net-worth-value { font-size: 2.5rem; font-weight: 700; }
        .net-worth-breakdown {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;
        }

        .chart-container { position: relative; height: 400px; margin-bottom: 2rem; }
        .report-controls {
            display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;
        }
        .status-bar {
            background: #1f2937; color: white; padding: 0.5rem 1.5rem;
            display: flex; justify-content: space-between; font-size: 0.75rem;
        }

        .text-success { color: var(--success-color); }
        .text-danger { color: var(--danger-color); }
        .text-muted { color: var(--text-secondary); }
        .checkbox-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        #fileInput { display: none; }

        .spinner {
            border: 3px solid var(--border); border-top: 3px solid var(--primary-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 2rem auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .profile-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem; border-bottom: 1px solid var(--border);
        }
        .profile-list-item:last-child { border-bottom: none; }
        .profile-list-item-name { display: flex; align-items: center; gap: 0.75rem; font-weight: 500; }
        .profile-list-item-actions { display: flex; gap: 0.5rem; }
        
        .combined-rule-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 8px; margin-bottom: 1.5rem; overflow: hidden;
        }
        .combined-rule-header {
            background: var(--background); padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        .combined-rule-header h3 { font-size: 1.25rem; margin-bottom: 0.25rem; }
        .combined-rule-sources { font-size: 0.875rem; color: var(--text-secondary); }
        .combined-rule-body {
            padding: 1.5rem; display: grid;
            grid-template-columns: 1fr 2fr; gap: 1.5rem;
        }
        .combined-rule-actions {
            background: var(--background); padding: 1rem; border-top: 1px solid var(--border);
        }

        @media (max-width: 900px) {
            .combined-rule-body { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .data-layout { grid-template-columns: 1fr; height: auto; }
            .forecast-days { grid-auto-columns: minmax(280px, 1fr); }
            .forecast-day { min-width: 280px; }
            .calendar-grid { gap: 0; font-size: 0.75rem; }
            .calendar-header { padding: 0.5rem 0.25rem; font-size: 0.7rem; }
            .calendar-day { min-height: 80px; padding: 0.25rem; }
            .day-number { font-size: 0.75rem; margin-bottom: 0.25rem; }
            .calendar-controls { flex-direction: column; align-items: stretch; }
            .sub-tab-content { padding: 0.75rem; }
        }
    </style>
</head>
<body>
    <div id="authScreen" class="auth-screen">
        <div class="auth-card">
            <h1>üí∞ Financial Calendar</h1>
            <p>Secure cloud storage with Google Drive</p>
            <button class="google-btn" onclick="app.authorize()">
                <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M17.6 9.2l-.1-1.8H9v3.4h4.8C13.6 12 13 13 12 13.6v2.2h3a8.8 8.8 0 0 0 2.6-6.6z" fill="#4285F4"/><path d="M9 18c2.4 0 4.5-.8 6-2.2l-3-2.2a5.4 5.4 0 0 1-8-2.9H1V13a9 9 0 0 0 8 5z" fill="#34A853"/><path d="M4 10.7a5.4 5.4 0 0 1 0-3.4V5H1a9 9 0 0 0 0 8l3-2.3z" fill="#FBBC05"/><path d="M9 3.6c1.3 0 2.5.4 3.4 1.3L15 2.3A9 9 0 0 0 1 5l3 2.4a5.4 5.4 0 0 1 5-3.7z" fill="#EA4335"/></g></svg>
                Sign in with Google
            </button>
            <div style="margin-top: 1.5rem; font-size: 0.75rem; color: var(--text-secondary); max-width: 350px;">
                <strong>Note:</strong> This app requires cookies to be enabled. If sign-in fails, please enable third-party cookies in your browser settings or allow popups for this site.
            </div>
            <div style="margin-top: 1rem;">
                <div class="spinner" id="authSpinner" style="display: none;"></div>
                <div id="authError" style="color: var(--danger-color); margin-top: 1rem; display: none; white-space: pre-wrap; text-align: left; font-size: 0.875rem; padding: 1rem; background: #fee; border-radius: 8px;"></div>
            </div>
        </div>
    </div>

    <div class="app-container" id="mainApp" style="display: none;">
        <header class="app-header">
            <div>
                <div class="app-title">Personal Financial Calendar</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);" id="profileSubtitle">Loading...</div>
            </div>
            <div class="user-info">
                <span class="sync-status" id="syncStatus">‚òÅÔ∏è Synced</span>
                <span class="user-email" id="userEmail"></span>
                <button class="btn btn-sm btn-secondary" onclick="app.signOut()">Sign Out</button>
            </div>
        </header>

        <div class="alert-badge" id="alertBadge" onclick="app.showAlerts()">
            <span>‚ö†Ô∏è</span>
            <span style="background: white; color: var(--danger-color); padding: 0.25rem 0.5rem; border-radius: 20px; font-weight: 700;" id="alertCount">0</span>
        </div>

        <nav class="master-navigation">
            <button class="master-tab-button active" id="master-tab-personal" onclick="app.handleMasterTabClick('personal')">
                üë§ Personal
            </button>
            <button class="master-tab-button" id="master-tab-combined" onclick="app.handleMasterTabClick('combined')">
                üë• Combined
            </button>
        </nav>

        <div id="personal-app-view" class="app-view active">
            <nav class="menu-bar">
                <div class="menu-item" onclick="app.showProfileManager()">Profiles</div>
                <div class="menu-item" onclick="app.exportCurrentProfile()">Export Local</div>
                <div class="menu-item" onclick="app.showImportProfile()">Import Local</div>
                <div class="menu-item" onclick="app.showSettings()">Settings</div>
            </nav>

            <div class="forecast-bar">
                <div class="forecast-container">
                    <div class="forecast-scroll-wrapper">
                        <div class="forecast-days" id="personal-forecastDays"></div>
                    </div>
                </div>
            </div>

            <nav class="sub-tab-navigation" id="personal-sub-nav">
                <button class="sub-tab-button active" data-tab="data">Data</button>
                <button class="sub-tab-button" data-tab="calendar">Calendar</button>
                <button class="sub-tab-button" data-tab="savings">Savings</button>
                <button class="sub-tab-button" data-tab="reports">Reports</button>
            </nav>

            <div id="personal-tab-data" class="sub-tab-content active">
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="app.showAddItemModal()" style="font-size: 1rem; padding: 0.75rem 1.5rem;">
                        ‚ûï Add New Item
                    </button>
                </div>
                <div class="data-layout">
                    <div class="panel">
                        <h2 class="panel-title">Profile & Net Worth</h2>
                        <div class="form-group">
                            <label class="form-label">Current Profile</label>
                            <select id="personal-profileSelector" class="form-control" onchange="app.switchProfile()"></select>
                        </div>
                        <div class="net-worth-display">
                            <div style="font-size: 0.875rem; opacity: 0.9;">Net Worth</div>
                            <div class="net-worth-value" id="personal-netWorthValue">$0</div>
                            <div class="net-worth-breakdown">
                                <div><div style="font-size: 0.75rem; opacity: 0.9;">Assets</div><div style="font-size: 1.25rem; font-weight: 600;" id="personal-totalAssets">$0</div></div>
                                <div><div style="font-size: 0.75rem; opacity: 0.9;">Liabilities</div><div style="font-size: 1.25rem; font-weight: 600;" id="personal-totalLiabilities">$0</div></div>
                            </div>
                        </div>
                        <div style="display: grid; gap: 1rem;">
                            <div><div style="font-size: 0.75rem; color: var(--text-secondary);">Monthly Income</div><div style="font-size: 1.5rem; font-weight: 700;" class="text-success" id="personal-monthlyIncome">$0</div></div>
                            <div><div style="font-size: 0.75rem; color: var(--text-secondary);">Monthly Expenses</div><div style="font-size: 1.5rem; font-weight: 700;" class="text-danger" id="personal-monthlyExpenses">$0</div></div>
                            <div><div style="font-size: 0.75rem; color: var(--text-secondary);">Monthly Cash Flow</div><div style="font-size: 1.5rem; font-weight: 700;" id="personal-monthlyCashFlow">$0</div></div>
                        </div>
                    </div>
                    <div class="panel">
                        <h2 class="panel-title">Data Overview</h2>
                        <ul class="data-tree" id="personal-dataTree"></ul>
                    </div>
                </div>
            </div>

            <div id="personal-tab-calendar" class="sub-tab-content">
                <div class="calendar-controls">
                    <div style="display: flex; gap: 1rem; align-items: center; flex: 1;">
                        <button class="btn btn-secondary" onclick="app.handleMonthChange(-1)">‚óÄ</button>
                        <div style="font-size: 1.25rem; font-weight: 600; flex: 1; text-align: center;" id="personal-calendarMonth"></div>
                        <button class="btn btn-secondary" onclick="app.handleMonthChange(1)">‚ñ∂</button>
                    </div>
                    <button class="btn btn-primary" onclick="app.handleGoToToday()">Today</button>
                </div>
                <div class="calendar-grid" id="personal-calendarGrid"></div>
            </div>

            <div id="personal-tab-savings" class="sub-tab-content">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
                    <h2 class="panel-title">Savings Plans</h2>
                    <button class="btn btn-primary" onclick="app.showCreateSavingsPlan()">+ New Plan</button>
                </div>
                <div id="personal-savingsPlansContainer"></div>
            </div>

            <div id="personal-tab-reports" class="sub-tab-content">
                <h2 class="panel-title">Financial Reports & Analysis</h2>
                <div class="report-controls">
                    <div class="form-group" style="min-width: 200px;"><label class="form-label">Report Type</label><select id="personal-reportType" class="form-control" onchange="app.renderActiveReports()"><option value="cash-flow">Cash Flow Forecast</option><option value="income-expense">Income vs Expenses</option><option value="category-breakdown">Category Breakdown</option><option value="net-worth-projection">Net Worth Projection</option></select></div>
                    <div class="form-group" style="min-width: 150px;"><label class="form-label">Time Period</label><select id="personal-reportPeriod" class="form-control" onchange="app.renderActiveReports()"><option value="1">1 Month</option><option value="3" selected>3 Months</option><option value="6">6 Months</option><option value="12">1 Year</option></select></div>
                    <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: flex-end;"><button class="btn btn-success" onclick="app.exportReportToDrive()">üíæ Save to Drive</button><button class="btn btn-secondary" onclick="app.downloadReportLocal()">‚¨áÔ∏è Download</button></div>
                </div>
                <div class="chart-container"><canvas id="personal-reportChart"></canvas></div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
                    <div style="background: var(--background); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border);"><div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Savings Rate</div><div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);" id="personal-savingsRate">0%</div><div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">Cash Flow / Income</div></div>
                    <div style="background: var(--background); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border);"><div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Debt-to-Income</div><div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);" id="personal-debtToIncome">0%</div><div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">Debt Payments / Income</div></div>
                    <div style="background: var(--background); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border);"><div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Avg Daily Balance</div><div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);" id="personal-avgDailyBalance">$0</div><div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">Next 30 days</div></div>
                </div>
            </div>
        </div>

        <div id="combined-app-view" class="app-view">
            <nav class="menu-bar">
                <div class="menu-item" onclick="app.showCombinedProfileManager()">Profiles</div>
                <div class="menu-item" onclick="app.exportCurrentProfile()">Export Local</div>
                <div class="menu-item" onclick="app.showSettings()">Settings</div>
            </nav>

            <div class="forecast-bar">
                <div class="forecast-container">
                    <div class="forecast-scroll-wrapper">
                        <div class="forecast-days" id="combined-forecastDays"></div>
                    </div>
                </div>
            </div>

            <nav class="sub-tab-navigation" id="combined-sub-nav">
                <button class="sub-tab-button active" data-tab="data">Data</button>
                <button class="sub-tab-button" data-tab="calendar">Calendar</button>
                <button class="sub-tab-button" data-tab="savings">Savings</button>
                <button class="sub-tab-button" data-tab="reports">Reports</button>
            </nav>

            <div id="combined-tab-data" class="sub-tab-content active">
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="app.showAddItemModal()" style="font-size: 1rem; padding: 0.75rem 1.5rem;">
                        ‚ûï Add New Item
                    </button>
                </div>
                <div class="data-layout">
                    <div class="panel">
                        <h2 class="panel-title">Profile & Net Worth</h2>
                        <div class="form-group">
                            <label class="form-label">Current Combined Profile</label>
                            <select id="combined-profileSelector" class="form-control" onchange="app.switchProfile()"></select>
                        </div>
                        <div class="net-worth-display">
                            <div style="font-size: 0.875rem; opacity: 0.9;">Net Worth</div>
                            <div class="net-worth-value" id="combined-netWorthValue">$0</div>
                            <div class="net-worth-breakdown">
                                <div><div style="font-size: 0.75rem; opacity: 0.9;">Assets</div><div style="font-size: 1.25rem; font-weight: 600;" id="combined-totalAssets">$0</div></div>
                                <div><div style="font-size: 0.75rem; opacity: 0.9;">Liabilities</div><div style="font-size: 1.25rem; font-weight: 600;" id="combined-totalLiabilities">$0</div></div>
                            </div>
                        </div>
                        <div style="display: grid; gap: 1rem;">
                            <div><div style="font-size: 0.75rem; color: var(--text-secondary);">Monthly Income</div><div style="font-size: 1.5rem; font-weight: 700;" class="text-success" id="combined-monthlyIncome">$0</div></div>
                            <div><div style="font-size: 0.75rem; color: var(--text-secondary);">Monthly Expenses</div><div style="font-size: 1.5rem; font-weight: 700;" class="text-danger" id="combined-monthlyExpenses">$0</div></div>
                            <div><div style="font-size: 0.75rem; color: var(--text-secondary);">Monthly Cash Flow</div><div style="font-size: 1.5rem; font-weight: 700;" id="combined-monthlyCashFlow">$0</div></div>
                        </div>
                    </div>
                    <div class="panel">
                        <h2 class="panel-title">Data Overview</h2>
                        <ul class="data-tree" id="combined-dataTree"></ul>
                    </div>
                </div>
            </div>

            <div id="combined-tab-calendar" class="sub-tab-content">
                <div class="calendar-controls">
                    <div style="display: flex; gap: 1rem; align-items: center; flex: 1;">
                        <button class="btn btn-secondary" onclick="app.handleMonthChange(-1)">‚óÄ</button>
                        <div style="font-size: 1.25rem; font-weight: 600; flex: 1; text-align: center;" id="combined-calendarMonth"></div>
                        <button class="btn btn-secondary" onclick="app.handleMonthChange(1)">‚ñ∂</button>
                    </div>
                    <button class="btn btn-primary" onclick="app.handleGoToToday()">Today</button>
                </div>
                <div class="calendar-grid" id="combined-calendarGrid"></div>
            </div>

            <div id="combined-tab-savings" class="sub-tab-content">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
                    <h2 class="panel-title">Savings Plans</h2>
                    <button class="btn btn-primary" onclick="app.showCreateSavingsPlan()">+ New Plan</button>
                </div>
                <div id="combined-savingsPlansContainer"></div>
            </div>

            <div id="combined-tab-reports" class="sub-tab-content">
                <h2 class="panel-title">Financial Reports & Analysis</h2>
                <div class="report-controls">
                    <div class="form-group" style="min-width: 200px;"><label class="form-label">Report Type</label><select id="combined-reportType" class="form-control" onchange="app.renderActiveReports()"><option value="cash-flow">Cash Flow Forecast</option><option value="income-expense">Income vs Expenses</option><option value="category-breakdown">Category Breakdown</option><option value="net-worth-projection">Net Worth Projection</option></select></div>
                    <div class="form-group" style="min-width: 150px;"><label class="form-label">Time Period</label><select id="combined-reportPeriod" class="form-control" onchange="app.renderActiveReports()"><option value="1">1 Month</option><option value="3" selected>3 Months</option><option value="6">6 Months</option><option value="12">1 Year</option></select></div>
                    <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: flex-end;"><button class="btn btn-success" onclick="app.exportReportToDrive()">üíæ Save to Drive</button><button class="btn btn-secondary" onclick="app.downloadReportLocal()">‚¨áÔ∏è Download</button></div>
                </div>
                <div class="chart-container"><canvas id="combined-reportChart"></canvas></div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
                    <div style="background: var(--background); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border);"><div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Savings Rate</div><div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);" id="combined-savingsRate">0%</div><div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">Cash Flow / Income</div></div>
                    <div style="background: var(--background); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border);"><div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Debt-to-Income</div><div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);" id="combined-debtToIncome">0%</div><div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">Debt Payments / Income</div></div>
                    <div style="background: var(--background); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border);"><div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Avg Daily Balance</div><div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);" id="combined-avgDailyBalance">$0</div><div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">Next 30 days</div></div>
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            <span id="statusMessage">Ready</span>
            <span id="lastSaved">Synced with Drive</span>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json" multiple>

    <div id="profileManagerModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 class="modal-title">Personal Profile Manager</h2>
                <button class="modal-close" onclick="app.closeProfileManager()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="panel">
                    <h3 class="panel-title">Create New Personal Profile</h3>
                    <div class="form-group">
                        <label class="form-label" for="newProfileName">New Profile Name</label>
                        <input type="text" id="newProfileName" class="form-control" placeholder="e.g., My Budget">
                    </div>
                    <button class="btn btn-primary" onclick="app.createNewProfile()">Create Profile</button>
                </div>
                <div class="panel" style="margin-top: 1.5rem;">
                    <h3 class="panel-title">Existing Personal Profiles</h3>
                    <div id="profileListContainer"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeProfileManager()">Close</button>
            </div>
        </div>
    </div>

    <div id="combinedProfileManagerModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 class="modal-title">Combined Profile Manager</h2>
                <button class="modal-close" onclick="app.closeCombinedProfileManager()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="panel">
                    <h3 class="panel-title">Create New Combined Profile</h3>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                         <div class="form-group" style="flex: 1; min-width: 250px;">
                            <label class="form-label" for="newCombinedProfileName">New Profile Name</label>
                            <input type="text" id="newCombinedProfileName" class="form-control" placeholder="e.g., Family Budget">
                        </div>
                        <div style="padding-top: 1.75rem;">
                            <button class="btn btn-success" onclick="app.showCreateCombinedProfileModal()">
                                üöÄ Create from Personal Profiles...
                            </button>
                        </div>
                    </div>
                </div>
                <div class="panel" style="margin-top: 1.5rem;">
                    <h3 class="panel-title">Existing Combined Profiles</h3>
                    <div id="combinedProfileListContainer"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeCombinedProfileManager()">Close</button>
            </div>
        </div>
    </div>
    
    <div id="createCombinedProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Combined Profile</h2>
                <button class="modal-close" onclick="app.closeCreateCombinedProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="combinedProfileName">New Combined Profile Name</label>
                    <input type="text" id="combinedProfileName" class="form-control" placeholder="e.g., Family Budget">
                </div>
                <div class="form-group">
                    <label class="form-label">Select Source Profiles (2 or more)</label>
                    <div id="combinedSourceProfilesList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeCreateCombinedProfileModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.handleCreateCombinedProfile()">Next: Edit Rules</button>
            </div>
        </div>
    </div>

    <div id="editCombinedRulesModal" class="modal">
        <div class="modal-content xlarge">
            <div class="modal-header">
                <h2 class="modal-title" id="editCombinedRulesTitle">Edit Combined Rules</h2>
                <button class="modal-close" onclick="app.closeEditCombinedRulesModal()">&times;</button>
            </div>
            <div class="modal-body" id="combinedRulesContainer">
                <div class="spinner"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeEditCombinedRulesModal()">Cancel</Readonly>
                <button class="btn btn-success" onclick="app.saveCombinedProfileRules()">Create Independent Profile</button>
            </div>
        </div>
    </div>

    <div id="savingsPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="savingsPlanModalTitle">Create Savings Plan</h2>
                <button class="modal-close" onclick="app.closeSavingsPlanModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Goal Name</label>
                    <input type="text" id="savingsPlanName" class="form-control" placeholder="e.g., Emergency Fund, Vacation">
                </div>
                <div class="form-group">
                    <label class="form-label">Target Amount ($)</label>
                    <input type="number" id="savingsPlanTarget" class="form-control" step="0.01" placeholder="5000.00">
                </div>
                <div class="form-group">
                    <label class="form-label">Target Date (Optional)</label>
                    <input type="date" id="savingsPlanDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select id="savingsPlanCategory" class="form-control">
                        <option value="emergency">Emergency Fund</option>
                        <option value="vacation">Vacation</option>
                        <option value="purchase">Large Purchase</option>
                        <option value="education">Education</option>
                        <option value="retirement">Retirement</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeSavingsPlanModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveSavingsPlan()">Save Plan</button>
            </div>
        </div>
    </div>

    <div id="savingsTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="savingsTransactionTitle">Add Contribution</h2>
                <button class="modal-close" onclick="app.closeSavingsTransactionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Amount ($)</label>
                    <input type="number" id="savingsTransactionAmount" class="form-control" step="0.01" placeholder="100.00">
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" id="savingsTransactionDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Note (Optional)</label>
                    <input type="text" id="savingsTransactionNote" class="form-control" placeholder="e.g., Bonus payment">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeSavingsTransactionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveSavingsTransaction()">Save</button>
            </div>
        </div>
    </div>

    <div id="savingsDetailModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 class="modal-title" id="savingsDetailTitle">Savings Plan Details</h2>
                <button class="modal-close" onclick="app.closeSavingsDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="savingsDetailContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="app.deleteSavingsPlan()">Delete Plan</button>
                <button class="btn btn-secondary" onclick="app.closeSavingsDetailModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'AIzaSyCeGRt1vaUNWc_ZMBsg26wR-wfSH8C3GKU';
        const CLIENT_ID = '994220951699-f5k7j6fig37c6gb9d9igjb9jjqoio59q.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const DRIVE_FILE_NAME = 'financial_calendar_data.json';

        const app = {
            // NEW: Master view state
            activeView: 'personal', // 'personal' or 'combined'

            // Data storage
            profiles: {},
            combinedProfiles: {},
            personalSavingsPlans: {},
            combinedSavingsPlans: {},
            personalPaymentInstances: {},
            combinedPaymentInstances: {},

            settings: { 
                safetyBuffer: 500, 
                lastUsedPersonalProfile: null,
                lastUsedCombinedProfile: null,
                driveFileId: null
            },
            
            // Google Auth
            isSignedIn: false,
            userEmail: '',
            accessToken: null,
            tokenClient: null,
            gapiInited: false,
            
            // NEW: View-specific UI states
            personalState: {
                activeProfileName: null,
                currentMonth: new Date().getMonth(),
                currentYear: new Date().getFullYear(),
                reportChart: null,
            },
            combinedState: {
                activeProfileName: null,
                currentMonth: new Date().getMonth(),
                currentYear: new Date().getFullYear(),
                reportChart: null,
            },

            // Global UI state
            isSyncing: false,
            currentAlerts: [], // Alerts now refresh on view change
            
            // NEW: Temporary storage for modal flow
            _tempCombined: {
                name: null,
                sourceNames: [],
                groupedItems: {}
            },

            // NEW: Temporary storage for savings modal
            _tempSavings: {
                currentPlanId: null,
                transactionType: null,
                editingPlan: null
            },

            // ============ GOOGLE AUTHENTICATION (GIS) ============
            
            handleClientLoad() {
                let attempts = 0;
                const checkReady = setInterval(() => {
                    attempts++;
                    if (typeof google !== 'undefined' && typeof gapi !== 'undefined') {
                        clearInterval(checkReady);
                        this.initializeGoogleSignIn();
                        this.initializeGapi();
                    } else if (attempts > 50) {
                        clearInterval(checkReady);
                        document.getElementById('authError').style.display = 'block';
                        document.getElementById('authError').textContent = 'Failed to load Google libraries. Please refresh.';
                    }
                }, 100);
            },

            initializeGoogleSignIn() {
                try {
                    this.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID, scope: SCOPES,
                        callback: (response) => {
                            if (response.error) {
                                console.error('Token error:', response.error);
                                document.getElementById('authError').style.display = 'block';
                                document.getElementById('authError').textContent = 'Error: ' + response.error;
                                return;
                            }
                            this.accessToken = response.access_token;
                            this.handleSignInSuccess();
                        },
                    });
                    this.renderSignInButton();
                } catch (error) {
                    console.error('‚ùå Error initializing GIS:', error);
                    document.getElementById('authError').style.display = 'block';
                    document.getElementById('authError').textContent = 'Failed to initialize sign-in: ' + error.message;
                }
            },

            renderSignInButton() {
                const authCard = document.querySelector('.auth-card');
                const existingBtn = authCard.querySelector('.google-btn');
                if (existingBtn) { existingBtn.onclick = () => this.authorize(); }
            },

            initializeGapi() {
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
                        await gapi.client.load('drive', 'v3');
                        this.gapiInited = true;
                    } catch (error) { console.error('Error initializing GAPI:', error); }
                });
            },

            authorize() {
                document.getElementById('authSpinner').style.display = 'block';
                document.getElementById('authError').style.display = 'none';
                if (!this.tokenClient) {
                    document.getElementById('authSpinner').style.display = 'none';
                    document.getElementById('authError').style.display = 'block';
                    document.getElementById('authError').textContent = 'Sign-in not ready. Please try again or refresh.';
                    return;
                }
                try { this.tokenClient.requestAccessToken({ prompt: 'consent' }); } 
                catch (error) {
                    console.error('Error requesting token:', error);
                    document.getElementById('authSpinner').style.display = 'none';
                    document.getElementById('authError').style.display = 'block';
                    document.getElementById('authError').textContent = 'Sign-in failed: ' + error.message;
                }
            },

            async handleSignInSuccess() {
                document.getElementById('authSpinner').style.display = 'none';
                try {
                    const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                        headers: { 'Authorization': `Bearer ${this.accessToken}` }
                    });
                    if (!response.ok) throw new Error('Failed to get user info');
                    const userInfo = await response.json();
                    this.userEmail = userInfo.email;
                    this.isSignedIn = true;
                    if (this.gapiInited) { gapi.client.setToken({ access_token: this.accessToken }); }
                    document.getElementById('authScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'flex';
                    document.getElementById('userEmail').textContent = this.userEmail;
                    this.loadFromDrive();
                } catch (error) {
                    console.error('Error during sign-in:', error);
                    document.getElementById('authError').style.display = 'block';
                    document.getElementById('authError').textContent = 'Sign-in failed: ' + error.message;
                }
            },

            signOut() {
                if (confirm('Sign out? Your data will remain in Google Drive.')) {
                    if (this.accessToken) { google.accounts.oauth2.revoke(this.accessToken, () => {}); }
                    this.accessToken = null; this.userEmail = null; this.isSignedIn = false;
                    if (this.gapiInited) { gapi.client.setToken(null); }
                    document.getElementById('authScreen').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                }
            },

            // ============ DATA SYNC FUNCTIONS ============

            async loadFromDrive() {
                this.setSyncStatus('loading');
                try {
                    const searchResponse = await fetch(
                        `https://www.googleapis.com/drive/v3/files?q=name='${DRIVE_FILE_NAME}'&fields=files(id,name)`,
                        { headers: { 'Authorization': `Bearer ${this.accessToken}` } }
                    );
                    if (!searchResponse.ok) throw new Error('Failed to search Drive files');
                    const searchResult = await searchResponse.json();
                    const files = searchResult.files;
                    
                    if (files && files.length > 0) {
                        const fileId = files[0].id;
                        this.settings.driveFileId = fileId;
                        const fileResponse = await fetch(
                            `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                            { headers: { 'Authorization': `Bearer ${this.accessToken}` } }
                        );
                        if (!fileResponse.ok) throw new Error('Failed to read file from Drive');
                        const data = await fileResponse.json();
                        // Load all data structures
                        this.profiles = data.profiles || {};
                        this.combinedProfiles = data.combinedProfiles || {};
                        this.personalSavingsPlans = data.personalSavingsPlans || {};
                        this.combinedSavingsPlans = data.combinedSavingsPlans || {};
                        this.personalPaymentInstances = data.personalPaymentInstances || {};
                        this.combinedPaymentInstances = data.combinedPaymentInstances || {};
                        this.settings = Object.assign({}, this.settings, data.settings);
                        this.settings.driveFileId = fileId;
                        
                        this.personalState.activeProfileName = this.settings.lastUsedPersonalProfile || Object.keys(this.profiles)[0];
                        this.combinedState.activeProfileName = this.settings.lastUsedCombinedProfile || Object.keys(this.combinedProfiles)[0];
                    } else {
                        // Create default personal profile
                        this.profiles['My Budget'] = { name: 'My Budget', assets: [], incomes: [], expenses: [] };
                        this.personalState.activeProfileName = 'My Budget';
                        this.settings.lastUsedPersonalProfile = 'My Budget';
                        await this.saveToDrive();
                    }
                    
                    this.setupEventListeners();
                    // Render the active view on load
                    this.renderActiveView(); 
                    this.setSyncStatus('synced');
                    
                } catch (error) {
                    console.error('Error loading from Drive:', error);
                    this.setSyncStatus('error');
                    this.profiles['My Budget'] = { name: 'My Budget', assets: [], incomes: [], expenses: [] };
                    this.personalState.activeProfileName = 'My Budget';
                    this.settings.lastUsedPersonalProfile = 'My Budget';
                    this.setupEventListeners();
                    this.renderActiveView();
                    alert('Could not load from Drive. Starting with empty data.');
                }
            },

            async saveToDrive() {
                if (this.isSyncing) return;
                this.isSyncing = true;
                this.setSyncStatus('syncing');
                try {
                    const data = {
                        profiles: this.profiles,
                        combinedProfiles: this.combinedProfiles,
                        personalSavingsPlans: this.personalSavingsPlans,
                        combinedSavingsPlans: this.combinedSavingsPlans,
                        personalPaymentInstances: this.personalPaymentInstances,
                        combinedPaymentInstances: this.combinedPaymentInstances,
                        settings: Object.assign({}, this.settings, { driveFileId: undefined })
                    };
                    const content = JSON.stringify(data, null, 2);
                    if (this.settings.driveFileId) {
                        await fetch(
                            `https://www.googleapis.com/upload/drive/v3/files/${this.settings.driveFileId}?uploadType=media`,
                            { method: 'PATCH', headers: { 'Authorization': `Bearer ${this.accessToken}`, 'Content-Type': 'application/json' }, body: content }
                        );
                    } else {
                        const metadata = { name: DRIVE_FILE_NAME, mimeType: 'application/json' };
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                        form.append('file', new Blob([content], { type: 'application/json' }));
                        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                            method: 'POST', headers: { 'Authorization': `Bearer ${this.accessToken}` }, body: form
                        });
                        const result = await response.json();
                        this.settings.driveFileId = result.id;
                    }
                    this.setSyncStatus('synced');
                } catch (error) {
                    console.error('Error saving to Drive:', error);
                    this.setSyncStatus('error');
                } finally {
                    this.isSyncing = false;
                }
            },

            setSyncStatus(status) {
                const statusEl = document.getElementById('syncStatus');
                const lastSavedEl = document.getElementById('lastSaved');
                switch(status) {
                    case 'loading': statusEl.textContent = '‚è≥ Loading...'; statusEl.style.background = 'var(--warning-color)'; break;
                    case 'syncing': statusEl.textContent = '‚¨ÜÔ∏è Syncing...'; statusEl.style.background = 'var(--warning-color)'; break;
                    case 'synced': statusEl.textContent = '‚òÅÔ∏è Synced'; statusEl.style.background = 'var(--success-color)'; lastSavedEl.textContent = `Synced: ${new Date().toLocaleTimeString()}`; break;
                    case 'error': statusEl.textContent = '‚ùå Error'; statusEl.style.background = 'var(--danger-color)'; break;
                }
            },
            
            async saveData() { await this.saveToDrive(); },

            // ============ NEW: MASTER NAVIGATION & STATE ============

            handleMasterTabClick(view) {
                if (view === this.activeView) return; // No change
                this.activeView = view;
                
                // Toggle master tabs
                document.getElementById('master-tab-personal').classList.toggle('active', view === 'personal');
                document.getElementById('master-tab-combined').classList.toggle('active', view === 'combined');
                
                // Toggle app views
                document.getElementById('personal-app-view').classList.toggle('active', view === 'personal');
                document.getElementById('combined-app-view').classList.toggle('active', view === 'combined');
                
                // Update the global subtitle
                this.updateProfileSubtitle();
                
                // Re-render all components for the newly active view
                this.renderActiveView();
            },

            // NEW: Getters for active context
            getActiveState() {
                return this.activeView === 'personal' ? this.personalState : this.combinedState;
            },
            getActiveDataStore() {
                return this.activeView === 'personal' ? this.profiles : this.combinedProfiles;
            },
            getActiveSavingsStore() {
                return this.activeView === 'personal' ? this.personalSavingsPlans : this.combinedSavingsPlans;
            },
            getActiveProfileData() {
                const state = this.getActiveState();
                const store = this.getActiveDataStore();
                if (state.activeProfileName && store[state.activeProfileName]) {
                    // Combined profiles store data in a .data sub-object
                    return this.activeView === 'combined' ? store[state.activeProfileName].data : store[state.activeProfileName];
                }
                return null; // No profile selected or found
            },
            getActiveUIContext() {
                const prefix = this.activeView; // 'personal' or 'combined'
                return {
                    view: this.activeView,
                    forecastDays: `${prefix}-forecastDays`,
                    profileSelector: `${prefix}-profileSelector`,
                    netWorthValue: `${prefix}-netWorthValue`,
                    totalAssets: `${prefix}-totalAssets`,
                    totalLiabilities: `${prefix}-totalLiabilities`,
                    monthlyIncome: `${prefix}-monthlyIncome`,
                    monthlyExpenses: `${prefix}-monthlyExpenses`,
                    monthlyCashFlow: `${prefix}-monthlyCashFlow`,
                    dataTree: `${prefix}-dataTree`,
                    calendarMonth: `${prefix}-calendarMonth`,
                    calendarGrid: `${prefix}-calendarGrid`,
                    savingsPlansContainer: `${prefix}-savingsPlansContainer`,
                    reportType: `${prefix}-reportType`,
                    reportPeriod: `${prefix}-reportPeriod`,
                    reportChart: `${prefix}-reportChart`,
                    savingsRate: `${prefix}-savingsRate`,
                    debtToIncome: `${prefix}-debtToIncome`,
                    avgDailyBalance: `${prefix}-avgDailyBalance`
                };
            },
            
            updateProfileSubtitle() {
                const state = this.getActiveState();
                const viewName = this.activeView.charAt(0).toUpperCase() + this.activeView.slice(1);
                document.getElementById('profileSubtitle').textContent = state.activeProfileName ? 
                    `${viewName}: ${state.activeProfileName}` : 
                    `No ${viewName} Profile Selected`;
            },

            // ============ NEW: MASTER RENDER FUNCTION ============

            /** Renders all components for the currently active view */
            renderActiveView() {
                this.updateProfileSubtitle();
                this.renderProfileSelector();
                
                const data = this.getActiveProfileData();
                const ui = this.getActiveUIContext();
                const state = this.getActiveState();

                if (!data) {
                    console.warn(`No active profile data for view: ${this.activeView}`);
                    // Optionally: clear or hide all components
                    return;
                }
                
                // Render Data Tab
                this.calculateMetrics(data, ui);
                this.renderDataTree(data, ui.dataTree);
                
                // Render Calendar Tab
                this.updateCalendar(data, ui, state.currentMonth, state.currentYear);
                
                // Render Savings Tab
                this.renderSavingsPlans();
                
                // Render Reports Tab
                this.renderActiveReports();
                
                // Render Forecast Bar
                this.update7DayForecast(data, ui);
                
                // Render Alerts
                this.updateAlerts(data);
            },
            
            renderActiveReports() {
                const data = this.getActiveProfileData();
                const ui = this.getActiveUIContext();
                const state = this.getActiveState();
                state.reportChart = this.renderReports(data, ui, state.reportChart);
            },


            // ============ REFACTORED: GENERIC FUNCTIONS ============
            
            formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
            },

            normalizeToMonthly(amount, frequency) {
                const m = { 'daily': 30.4375, 'weekly': 4.3333, 'biweekly': 2.1666, 'monthly': 1, 'quarterly': 1/3, 'annually': 1/12 };
                return amount * (m[frequency] || 0);
            },
            
            isScheduledForDate(item, checkDate) {
                if (!item.startDate) return false;
                const startDate = new Date(item.startDate);
                const check = new Date(checkDate);
                check.setHours(0, 0, 0, 0); startDate.setHours(0, 0, 0, 0);
                if (check < startDate) return false;
                if (item.endDate) {
                    const endDate = new Date(item.endDate);
                    endDate.setHours(0, 0, 0, 0);
                    if (check > endDate) return false;
                }
                const daysDiff = Math.floor((check - startDate) / (1000 * 60 * 60 * 24));
                switch (item.frequency) {
                    case 'daily': return true;
                    case 'weekly': return daysDiff % 7 === 0;
                    case 'biweekly': return daysDiff % 14 === 0;
                    case 'monthly': return check.getDate() === startDate.getDate();
                    case 'quarterly':
                        if (check.getDate() !== startDate.getDate()) return false;
                        const monthsDiff = (check.getFullYear() - startDate.getFullYear()) * 12 + (check.getMonth() - startDate.getMonth());
                        return monthsDiff % 3 === 0;
                    case 'annually': return check.getDate() === startDate.getDate() && check.getMonth() === startDate.getMonth();
                    default: return false;
                }
            },
            
            update7DayForecast(data, ui) {
                const container = document.getElementById(ui.forecastDays);
                container.innerHTML = '';
                const startDate = new Date(); startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(startDate); endDate.setDate(endDate.getDate() + 6);
                const ledger = this.calculateRunningBalance(startDate, endDate, data);
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startDate); date.setDate(date.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    const dayData = ledger[dateStr] || { balance: 0, transactions: [] };
                    const dayCard = document.createElement('div');
                    dayCard.className = 'forecast-day';
                    if (i === 0) dayCard.classList.add('today');
                    if (dayData.balance < this.settings.safetyBuffer) dayCard.classList.add('warning');
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                    const dayNum = date.getDate();
                    const month = date.toLocaleDateString('en-US', { month: 'short' });
                    dayCard.innerHTML = `
                        <div class="forecast-day-header"><div class="forecast-day-name">${dayName}, ${month} ${dayNum}</div></div>
                        <div class="forecast-transactions">${dayData.transactions.length} transaction${dayData.transactions.length !== 1 ? 's' : ''}</div>
                        <div class="forecast-balance ${dayData.balance < this.settings.safetyBuffer ? 'warning' : ''}">${this.formatCurrency(dayData.balance)}</div>`;
                    dayCard.onclick = () => { alert('7-day forecast day detail - Feature coming soon!'); };
                    container.appendChild(dayCard);
                }
            },

            calculateRunningBalance(startDate, endDate, data) {
                if (!data) return {};
                let balance = 0;
                (data.assets || []).forEach(asset => {
                    if (asset.category === 'cash' || asset.category === 'checking') { balance += asset.value || 0; }
                });
                const ledger = {};
                const currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const transactions = [];
                    (data.incomes || []).forEach(income => {
                        if (this.isScheduledForDate(income, currentDate)) {
                            transactions.push({ ...income, type: 'income' });
                            balance += income.amount;
                        }
                    });
                    (data.expenses || []).forEach(expense => {
                        if (this.isScheduledForDate(expense, currentDate)) {
                            transactions.push({ ...expense, type: 'expense' });
                            balance -= expense.amount;
                        }
                    });
                    ledger[dateStr] = { balance: balance, transactions: transactions };
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                return ledger;
            },

            updateAlerts(data) {
                this.currentAlerts = [];
                const startDate = new Date();
                const endDate = new Date(); endDate.setDate(endDate.getDate() + 30);
                const ledger = this.calculateRunningBalance(startDate, endDate, data);
                Object.keys(ledger).forEach(dateStr => {
                    const dayData = ledger[dateStr];
                    if (dayData.balance < 0) {
                        this.currentAlerts.push({ type: 'critical', date: dateStr, message: `Negative balance: ${this.formatCurrency(dayData.balance)}` });
                    } else if (dayData.balance < this.settings.safetyBuffer) {
                        this.currentAlerts.push({ type: 'warning', date: dateStr, message: `Below safety buffer: ${this.formatCurrency(dayData.balance)}` });
                    }
                });
                const alertBadge = document.getElementById('alertBadge');
                const alertCount = document.getElementById('alertCount');
                if (this.currentAlerts.length > 0) {
                    alertBadge.classList.add('active');
                    alertCount.textContent = this.currentAlerts.length;
                } else {
                    alertBadge.classList.remove('active');
                }
            },
            showAlerts() { alert(`${this.currentAlerts.length} alerts found for the active profile. Alert modal feature coming soon!`); },

            renderProfileSelector() {
                const state = this.getActiveState();
                const store = this.getActiveDataStore();
                const ui = this.getActiveUIContext();
                const selector = document.getElementById(ui.profileSelector);
                selector.innerHTML = '';
                Object.keys(store).forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    if (name === state.activeProfileName) option.selected = true;
                    selector.appendChild(option);
                });
            },

            switchProfile() {
                const state = this.getActiveState();
                const ui = this.getActiveUIContext();
                const selector = document.getElementById(ui.profileSelector);
                state.activeProfileName = selector.value;
                if (this.activeView === 'personal') {
                    this.settings.lastUsedPersonalProfile = state.activeProfileName;
                } else {
                    this.settings.lastUsedCombinedProfile = state.activeProfileName;
                }
                this.saveData();
                this.renderActiveView(); // Full re-render for new profile
            },

            calculateMetrics(data, outputIds) {
                if (!data) return;
                let totalAssets = 0, totalLiabilities = 0, monthlyIncome = 0, monthlyExpenses = 0;
                (data.assets || []).forEach(asset => {
                    totalAssets += asset.value || 0;
                    if (asset.category === 'debt') totalLiabilities += Math.abs(asset.value || 0);
                });
                (data.incomes || []).forEach(income => monthlyIncome += this.normalizeToMonthly(income.amount, income.frequency));
                (data.expenses || []).forEach(expense => monthlyExpenses += this.normalizeToMonthly(expense.amount, expense.frequency));
                const netWorth = totalAssets - totalLiabilities;
                const monthlyCashFlow = monthlyIncome - monthlyExpenses;
                document.getElementById(outputIds.netWorthValue).textContent = this.formatCurrency(netWorth);
                document.getElementById(outputIds.totalAssets).textContent = this.formatCurrency(totalAssets);
                document.getElementById(outputIds.totalLiabilities).textContent = this.formatCurrency(totalLiabilities);
                document.getElementById(outputIds.monthlyIncome).textContent = this.formatCurrency(monthlyIncome);
                document.getElementById(outputIds.monthlyExpenses).textContent = this.formatCurrency(monthlyExpenses);
                document.getElementById(outputIds.monthlyCashFlow).textContent = this.formatCurrency(monthlyCashFlow);
                document.getElementById(outputIds.monthlyCashFlow).className = monthlyCashFlow >= 0 ? 'text-success' : 'text-danger';
            },

            renderDataTree(data, outputId) {
                const container = document.getElementById(outputId);
                if (!data) { container.innerHTML = '<div>No data available</div>'; return; }
                let html = '';
                if (data.assets && data.assets.length > 0) {
                    html += '<li class="tree-category"><div class="tree-category-header">Assets</div><ul>';
                    data.assets.forEach(asset => { html += `<li class="tree-item">${asset.name} - ${this.formatCurrency(asset.value || 0)}</li>`; });
                    html += '</ul></li>';
                }
                if (data.incomes && data.incomes.length > 0) {
                    html += '<li class="tree-category"><div class="tree-category-header">Income Sources</div><ul>';
                    data.incomes.forEach(income => { html += `<li class="tree-item">${income.name} - ${this.formatCurrency(income.amount)} (${income.frequency})</li>`; });
                    html += '</ul></li>';
                }
                if (data.expenses && data.expenses.length > 0) {
                    html += '<li class="tree-category"><div class="tree-category-header">Expenses</div><ul>';
                    data.expenses.forEach(expense => { html += `<li class="tree-item">${expense.name} - ${this.formatCurrency(expense.amount)} (${expense.frequency})</li>`; });
                    html += '</ul></li>';
                }
                container.innerHTML = html || '<div>No items yet</div>';
            },

            updateCalendar(data, outputIds, month, year) {
                document.getElementById(outputIds.calendarMonth).textContent = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                const grid = document.getElementById(outputIds.calendarGrid);
                grid.innerHTML = '';
                const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayHeaders.forEach(day => {
                    const header = document.createElement('div');
                    header.className = 'calendar-header'; header.textContent = day; grid.appendChild(header);
                });
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day'; emptyDay.style.background = '#f3f4f6'; grid.appendChild(emptyDay);
                }
                const startDate = new Date(year, month, 1);
                const endDate = new Date(year, month, daysInMonth);
                const ledger = this.calculateRunningBalance(startDate, endDate, data);
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateStr = date.toISOString().split('T')[0];
                    const dayData = ledger[dateStr] || { balance: 0, transactions: [] };
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    if (dayData.balance < this.settings.safetyBuffer) dayEl.classList.add('warning');
                    dayEl.innerHTML = `
                        <div class="day-number">${day}</div>
                        <div style="font-size: 0.7rem; color: var(--text-secondary);">${dayData.transactions.length} items</div>
                        <div style="font-size: 0.75rem; font-weight: 600; margin-top: 0.25rem;">${this.formatCurrency(dayData.balance)}</div>`;
                    dayEl.onclick = () => { alert('Calendar day detail - Feature coming soon!'); };
                    grid.appendChild(dayEl);
                }
            },
            
            handleMonthChange(direction) {
                const state = this.getActiveState();
                state.currentMonth += direction;
                if (state.currentMonth < 0) { state.currentMonth = 11; state.currentYear--; }
                if (state.currentMonth > 11) { state.currentMonth = 0; state.currentYear++; }
                this.updateCalendar(this.getActiveProfileData(), this.getActiveUIContext(), state.currentMonth, state.currentYear);
            },
            handleGoToToday() {
                const state = this.getActiveState();
                const today = new Date();
                state.currentMonth = today.getMonth();
                state.currentYear = today.getFullYear();
                this.updateCalendar(this.getActiveProfileData(), this.getActiveUIContext(), state.currentMonth, state.currentYear);
            },
            
            // ============ REFACTORED: REPORTS ============
            
            renderReports(data, ui, chartInstance) {
                const reportType = document.getElementById(ui.reportType).value;
                const period = parseInt(document.getElementById(ui.reportPeriod).value);
                const startDate = new Date();
                const endDate = new Date(); endDate.setMonth(endDate.getMonth() + period);
                const ledger = this.calculateRunningBalance(startDate, endDate, data);
                const ctx = document.getElementById(ui.reportChart).getContext('2d');
                if (chartInstance) chartInstance.destroy();
                let newChart;
                switch(reportType) {
                    case 'cash-flow': newChart = this.renderCashFlowChart(ctx, ledger); break;
                    case 'income-expense': newChart = this.renderIncomeExpenseChart(ctx, data); break;
                    case 'category-breakdown': newChart = this.renderCategoryBreakdownChart(ctx, data); break;
                    case 'net-worth-projection': newChart = this.renderNetWorthProjectionChart(ctx, ledger, data); break;
                }
                this.updateReportMetrics(ledger, data, ui);
                return newChart;
            },
            renderCashFlowChart(ctx, ledger) {
                const dates = [], balances = [];
                Object.keys(ledger).sort().forEach(dateStr => {
                    const data = ledger[dateStr];
                    dates.push(new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    balances.push(data.balance);
                });
                return new Chart(ctx, {
                    type: 'line', data: { labels: dates, datasets: [
                        { label: 'Cash Balance', data: balances, borderColor: 'rgb(37, 99, 235)', backgroundColor: 'rgba(37, 99, 235, 0.1)', tension: 0.1, fill: true },
                        { label: 'Safety Buffer', data: new Array(dates.length).fill(this.settings.safetyBuffer), borderColor: 'rgb(239, 68, 68)', borderDash: [5, 5], tension: 0, fill: false, pointRadius: 0 }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top' }, title: { display: true, text: 'Cash Flow Forecast' } }, scales: { y: { ticks: { callback: (value) => '$' + value.toLocaleString() } } } }
                });
            },
            renderIncomeExpenseChart(ctx, data) {
                if (!data) return;
                let monthlyIncome = 0; (data.incomes || []).forEach(income => monthlyIncome += this.normalizeToMonthly(income.amount, income.frequency));
                let monthlyExpenses = 0; (data.expenses || []).forEach(expense => monthlyExpenses += this.normalizeToMonthly(expense.amount, expense.frequency));
                return new Chart(ctx, {
                    type: 'bar', data: { labels: ['Monthly Income', 'Monthly Expenses', 'Net Cash Flow'], datasets: [{
                        label: 'Amount ($)', data: [monthlyIncome, monthlyExpenses, monthlyIncome - monthlyExpenses],
                        backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)', monthlyIncome - monthlyExpenses >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)']
                    }]},
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Income vs Expenses Analysis' } }, scales: { y: { ticks: { callback: (value) => '$' + value.toLocaleString() } } } }
                });
            },
            renderCategoryBreakdownChart(ctx, data) {
                if (!data) return;
                const categoryTotals = {};
                (data.expenses || []).forEach(expense => {
                    const monthlyAmount = this.normalizeToMonthly(expense.amount, expense.frequency);
                    categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + monthlyAmount;
                });
                const labels = Object.keys(categoryTotals), values = Object.values(categoryTotals);
                return new Chart(ctx, {
                    type: 'pie', data: { labels: labels, datasets: [{
                        data: values, backgroundColor: ['rgba(239, 68, 68, 0.8)', 'rgba(249, 115, 22, 0.8)', 'rgba(220, 38, 38, 0.8)', 'rgba(139, 92, 246, 0.8)', 'rgba(107, 114, 128, 0.8)']
                    }]},
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'right' }, title: { display: true, text: 'Monthly Expense Breakdown by Category' } } }
                });
            },
            renderNetWorthProjectionChart(ctx, ledger, data) {
                if (!data) return;
                let currentAssets = 0; (data.assets || []).forEach(asset => currentAssets += asset.value || 0);
                const dates = [], netWorth = [];
                Object.keys(ledger).sort().forEach(dateStr => {
                    const dayData = ledger[dateStr];
                    dates.push(new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    netWorth.push(currentAssets + dayData.balance); // Simplification
                });
                return new Chart(ctx, {
                    type: 'line', data: { labels: dates, datasets: [{
                        label: 'Net Worth', data: netWorth, borderColor: 'rgb(16, 185, 129)', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.1, fill: true
                    }]},
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top' }, title: { display: true, text: 'Net Worth Projection' } }, scales: { y: { ticks: { callback: (value) => '$' + value.toLocaleString() } } } }
                });
            },
            updateReportMetrics(ledger, data, outputIds) {
                if (!data) return;
                let monthlyIncome = 0; (data.incomes || []).forEach(income => monthlyIncome += this.normalizeToMonthly(income.amount, income.frequency));
                let monthlyExpenses = 0; (data.expenses || []).forEach(expense => monthlyExpenses += this.normalizeToMonthly(expense.amount, expense.frequency));
                const monthlyCashFlow = monthlyIncome - monthlyExpenses;
                const savingsRate = monthlyIncome > 0 ? (monthlyCashFlow / monthlyIncome) * 100 : 0;
                document.getElementById(outputIds.savingsRate).textContent = savingsRate.toFixed(1) + '%';
                let monthlyDebt = 0;
                (data.expenses || []).forEach(expense => { if (expense.category === 'debt') { monthlyDebt += this.normalizeToMonthly(expense.amount, expense.frequency); } });
                const dti = monthlyIncome > 0 ? (monthlyDebt / monthlyIncome) * 100 : 0;
                document.getElementById(outputIds.debtToIncome).textContent = dti.toFixed(1) + '%';
                const next30Days = Object.keys(ledger).sort().slice(0, 30);
                if (next30Days.length > 0) {
                    const avgBalance = next30Days.reduce((sum, date) => sum + ledger[date].balance, 0) / next30Days.length;
                    document.getElementById(outputIds.avgDailyBalance).textContent = this.formatCurrency(avgBalance);
                }
            },
            exportReportToDrive() { alert('Exporting reports to Drive - Feature coming soon!'); },
            downloadReportLocal() {
                const ui = this.getActiveUIContext();
                const reportType = document.getElementById(ui.reportType).value;
                const canvas = document.getElementById(ui.reportChart);
                const link = document.createElement('a');
                link.download = `financial_report_${this.activeView}_${reportType}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
            },

            // ============ MENU & ITEM FUNCTIONS ============

            showAddItemModal() { alert('Add item modal - Feature coming soon! Use import to load data for now.'); },
            showSettings() {
                const newBuffer = prompt('Enter safety buffer amount ($):', this.settings.safetyBuffer);
                if (newBuffer !== null) {
                    this.settings.safetyBuffer = parseFloat(newBuffer) || 500;
                    this.saveData();
                    this.renderActiveView(); // Re-render to show new buffer
                }
            },
            exportCurrentProfile() {
                const state = this.getActiveState();
                const data = this.getActiveProfileData();
                if (!data) { alert('No active profile to export.'); return; }
                const exportData = { profile: data, name: state.activeProfileName };
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${state.activeProfileName.replace(/\s/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            },
            showImportProfile() {
                if (this.activeView === 'combined') {
                    alert('Importing is only available for Personal profiles. To create a Combined profile, use the Profile Manager in the Combined tab.');
                    return;
                }
                document.getElementById('fileInput').click();
            },
            handleFileImport(files) {
                if (this.activeView !== 'personal') return; // Safety check
                if (!files || files.length === 0) return;
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);
                            if (imported.profile && imported.name) {
                                this.profiles[imported.name] = imported.profile;
                                this.personalState.activeProfileName = imported.name;
                                this.settings.lastUsedPersonalProfile = imported.name;
                                this.saveData();
                                this.renderActiveView();
                                alert(`Imported profile: ${imported.name}`);
                            }
                        } catch (error) { alert('Error importing file: ' + error.message); }
                    };
                    reader.readAsText(file);
                });
            },
            
            // ============ PERSONAL PROFILE MANAGER ============

            showProfileManager() {
                this.renderProfileList();
                document.getElementById('profileManagerModal').classList.add('active');
            },
            closeProfileManager() { document.getElementById('profileManagerModal').classList.remove('active'); },
            renderProfileList() {
                const container = document.getElementById('profileListContainer');
                container.innerHTML = '';
                Object.keys(this.profiles).forEach(profileName => {
                    const item = document.createElement('div');
                    item.className = 'profile-list-item';
                    item.innerHTML = `
                        <div class="profile-list-item-name"><span>${profileName}</span></div>
                        <div class="profile-list-item-actions">
                            <button class="btn btn-sm btn-secondary" onclick="app.renameProfile('${profileName}')">Rename</button>
                            <button class="btn btn-sm btn-danger" onclick="app.deleteProfile('${profileName}')">Delete</button>
                        </div>`;
                    container.appendChild(item);
                });
            },
            createNewProfile() {
                const inputEl = document.getElementById('newProfileName');
                const newName = inputEl.value.trim();
                if (!newName) { alert('Please enter a profile name.'); return; }
                if (this.profiles[newName]) { alert('A profile with this name already exists.'); return; }
                this.profiles[newName] = { name: newName, assets: [], incomes: [], expenses: [] };
                this.personalState.activeProfileName = newName;
                this.settings.lastUsedPersonalProfile = newName;
                this.saveData();
                this.renderProfileList();
                this.renderActiveView();
                inputEl.value = '';
                alert(`Profile "${newName}" created and set as active.`);
            },
            renameProfile(oldName) {
                const newName = prompt(`Enter new name for "${oldName}":`, oldName);
                if (!newName || newName.trim() === '' || newName === oldName) return; 
                if (this.profiles[newName]) { alert('A profile with this name already exists.'); return; }
                this.profiles[newName] = this.profiles[oldName];
                this.profiles[newName].name = newName; 
                delete this.profiles[oldName];
                if (this.personalState.activeProfileName === oldName) {
                    this.personalState.activeProfileName = newName;
                    this.settings.lastUsedPersonalProfile = newName;
                }
                this.saveData();
                this.renderProfileList();
                this.renderActiveView();
            },
            deleteProfile(profileName) {
                if (Object.keys(this.profiles).length <= 1) { alert('Cannot delete the last personal profile.'); return; }
                if (confirm(`Are you sure you want to delete profile "${profileName}"? This cannot be undone.`)) {
                    delete this.profiles[profileName];
                    if (this.personalState.activeProfileName === profileName) {
                        this.personalState.activeProfileName = Object.keys(this.profiles)[0];
                        this.settings.lastUsedPersonalProfile = this.personalState.activeProfileName;
                    }
                    this.saveData();
                    this.renderProfileList();
                    this.renderActiveView();
                }
            },
            
            // ============ COMBINED PROFILE MANAGER & CREATION ============
            
            showCombinedProfileManager() {
                this.renderCombinedProfileList();
                document.getElementById('combinedProfileManagerModal').classList.add('active');
            },
            closeCombinedProfileManager() { document.getElementById('combinedProfileManagerModal').classList.remove('active'); },
            renderCombinedProfileList() {
                const container = document.getElementById('combinedProfileListContainer');
                container.innerHTML = '';
                Object.keys(this.combinedProfiles).forEach(profileName => {
                    const item = document.createElement('div');
                    item.className = 'profile-list-item';
                    item.innerHTML = `
                        <div class="profile-list-item-name"><span>${profileName}</span></div>
                        <div class="profile-list-item-actions">
                            <button class="btn btn-sm btn-secondary" onclick="app.renameCombinedProfile('${profileName}')">Rename</button>
                            <button class="btn btn-sm btn-danger" onclick="app.deleteCombinedProfile('${profileName}')">Delete</button>
                        </div>`;
                    container.appendChild(item);
                });
            },
            renameCombinedProfile(oldName) {
                const newName = prompt(`Enter new name for "${oldName}":`, oldName);
                if (!newName || newName.trim() === '' || newName === oldName) return; 
                if (this.combinedProfiles[newName]) { alert('A combined profile with this name already exists.'); return; }
                this.combinedProfiles[newName] = this.combinedProfiles[oldName];
                this.combinedProfiles[newName].name = newName; 
                delete this.combinedProfiles[oldName];
                if (this.combinedState.activeProfileName === oldName) {
                    this.combinedState.activeProfileName = newName;
                    this.settings.lastUsedCombinedProfile = newName;
                }
                this.saveData();
                this.renderCombinedProfileList();
                this.renderActiveView();
            },
            deleteCombinedProfile(profileName) {
                if (confirm(`Are you sure you want to delete combined profile "${profileName}"? This cannot be undone.`)) {
                    delete this.combinedProfiles[profileName];
                    if (this.combinedState.activeProfileName === profileName) {
                        this.combinedState.activeProfileName = Object.keys(this.combinedProfiles)[0] || null;
                        this.settings.lastUsedCombinedProfile = this.combinedState.activeProfileName;
                    }
                    this.saveData();
                    this.renderCombinedProfileList();
                    this.renderActiveView();
                }
            },
            
            // --- Combined Creation Flow ---
            showCreateCombinedProfileModal() {
                const newName = document.getElementById('newCombinedProfileName').value.trim();
                if (!newName) {
                    alert('Please enter a name for the new combined profile first.');
                    return;
                }
                if (this.combinedProfiles[newName]) {
                    alert('A combined profile with this name already exists.');
                    return;
                }
                // Store name and open next modal
                this._tempCombined.name = newName;
                const listContainer = document.getElementById('combinedSourceProfilesList');
                listContainer.innerHTML = '';
                Object.keys(this.profiles).forEach(name => {
                    listContainer.innerHTML += `
                        <div class="checkbox-group">
                            <input type="checkbox" id="check-profile-${name}" class="combined-source-check" data-name="${name}">
                            <label for="check-profile-${name}">${name}</label>
                        </div>`;
                });
                document.getElementById('combinedProfileName').value = newName;
                document.getElementById('createCombinedProfileModal').classList.add('active');
            },
            closeCreateCombinedProfileModal() {
                document.getElementById('createCombinedProfileModal').classList.remove('active');
                this._tempCombined.name = null;
            },
            handleCreateCombinedProfile() {
                const newName = document.getElementById('combinedProfileName').value.trim(); // Get name from *this* modal
                const selected = document.querySelectorAll('.combined-source-check:checked');
                const sourceNames = Array.from(selected).map(el => el.dataset.name);
                if (sourceNames.length < 2) {
                    alert('Please select at least two profiles to combine.'); return;
                }
                this._tempCombined = { name: newName, sourceNames: sourceNames, groupedItems: {} };
                this.closeCreateCombinedProfileModal();
                this.showEditCombinedRulesModal();
            },
            showEditCombinedRulesModal() {
                const container = document.getElementById('combinedRulesContainer');
                container.innerHTML = '<div class="spinner"></div><p style="text-align: center;">Grouping items...</p>';
                document.getElementById('editCombinedRulesTitle').textContent = `Edit Rules for ${this._tempCombined.name} (NEW)`;
                document.getElementById('editCombinedRulesModal').classList.add('active');
                
                // Group items
                const groupedItems = this.generateCombinedRuleGroups(this._tempCombined.sourceNames);
                this._tempCombined.groupedItems = groupedItems; 
                
                // Render the editor UI
                this.renderCombinedRuleEditor(container, groupedItems);
            },
            closeEditCombinedRulesModal() {
                document.getElementById('editCombinedRulesModal').classList.remove('active');
                this._tempCombined = { name: null, sourceNames: [], groupedItems: {} }; // Clear temp
            },
            generateCombinedRuleGroups(sourceNames) {
                const grouped = { incomes: {}, expenses: {} };
                sourceNames.forEach(profileName => {
                    const profile = this.profiles[profileName];
                    if (!profile) return;
                    ['incomes', 'expenses'].forEach(type => {
                        (profile[type] || []).forEach(item => {
                            const key = item.name.toLowerCase().trim();
                            if (!grouped[type][key]) {
                                grouped[type][key] = { name: item.name, type: type, items: [] };
                            }
                            grouped[type][key].items.push({ ...item, sourceProfile: profileName });
                        });
                    });
                });
                return grouped;
            },
            renderCombinedRuleEditor(container, groupedItems) {
                let html = '<p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1.5rem;">For each group, decide whether to keep items separate (Personal) or merge them into a single item (Shared). This will create a new, independent profile.</p>';
                ['incomes', 'expenses'].forEach(type => {
                    html += `<h2 class="panel-title" style="text-transform: capitalize; margin-top: 1rem;">${type}</h2>`;
                    const groups = groupedItems[type];
                    if (Object.keys(groups).length === 0) { html += `<p style="color: var(--text-secondary);">No ${type} found.</p>`; return; }
                    Object.keys(groups).sort().forEach(key => {
                        const group = groups[key];
                        const total = group.items.reduce((sum, item) => sum + item.amount, 0);
                        html += `
                        <div class="combined-rule-card">
                            <div class="combined-rule-header">
                                <h3>${group.name}</h3>
                                <div class="combined-rule-sources">Found in: ${group.items.map(i => `${i.sourceProfile} (${this.formatCurrency(i.amount)})`).join(', ')}</div>
                            </div>
                            <div class="combined-rule-body" id="rule-body-${key}-${type}">
                                <div class="form-group">
                                    <label class="form-label">Share Status</label>
                                    <select class="form-control" data-group-key="${key}" data-type="${type}" onchange="app.toggleCombinedRuleView(this)">
                                        <option value="personal">Personal (Keep items separate)</option>
                                        <option value="shared">Shared (Combine as one item)</option>
                                    </select>
                                </div>
                                <div class="shared-options" style="display: none;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                        <div class="form-group"><label class="form-label">Combined Amount ($)</label><input type="number" class="form-control" value="${total}" step="0.01"></div>
                                        <div class="form-group"><label class="form-label">Frequency</label><select class="form-control" value="${group.items[0].frequency}"><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="biweekly">Bi-weekly</option><option value="monthly">Monthly</option><option value="quarterly">Quarterly</option><option value="annually">Annually</option></select></div>
                                        <div class="form-group"><label class="form-label">Start Date</label><input type="date" class="form-control" value="${group.items[0].startDate}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });
                });
                container.innerHTML = html;
            },
            toggleCombinedRuleView(selectElement) {
                const sharedOptions = selectElement.closest('.combined-rule-body').querySelector('.shared-options');
                sharedOptions.style.display = selectElement.value === 'shared' ? 'block' : 'none';
            },
            saveCombinedProfileRules() {
                const newData = { assets: [], incomes: [], expenses: [] };
                // 1. Combine all assets (simple sum for now)
                this._tempCombined.sourceNames.forEach(profileName => {
                    const profile = this.profiles[profileName];
                    if (profile && profile.assets) { newData.assets.push(...profile.assets); }
                });
                // 2. Process rules for incomes and expenses
                ['incomes', 'expenses'].forEach(type => {
                    const groups = this._tempCombined.groupedItems[type];
                    Object.keys(groups).forEach(key => {
                        const group = groups[key];
                        const body = document.getElementById(`rule-body-${key}-${type}`);
                        const status = body.querySelector('select').value;
                        if (status === 'personal') {
                            newData[type].push(...group.items);
                        } else {
                            const inputs = body.querySelector('.shared-options');
                            const amount = parseFloat(inputs.querySelector('input[type="number"]').value);
                            const frequency = inputs.querySelector('select').value;
                            const startDate = inputs.querySelector('input[type="date"]').value;
                            newData[type].push({
                                id: `combined_${type}_${key}_${Date.now()}`, name: group.name, amount: amount,
                                frequency: frequency, startDate: startDate, category: group.items[0].category,
                                sourceItems: group.items // Store original items for reference
                            });
                        }
                    });
                });
                // 3. Save the new *independent* profile
                const profileName = this._tempCombined.name;
                this.combinedProfiles[profileName] = {
                    id: profileName, name: profileName,
                    sourceProfiles: this._tempCombined.sourceNames,
                    data: newData // This is the new, independent, editable data
                };
                this.combinedState.activeProfileName = profileName;
                this.settings.lastUsedCombinedProfile = profileName;
                this.saveData();
                this.closeEditCombinedRulesModal();
                this.closeCombinedProfileManager();
                this.renderActiveView(); // Refresh the active (Combined) view
                alert(`New independent profile "${profileName}" created!`);
            },
            
            // ============ REFACTORED: SAVINGS PLANS ============
            
            renderSavingsPlans() {
                const store = this.getActiveSavingsStore();
                const ui = this.getActiveUIContext();
                const container = document.getElementById(ui.savingsPlansContainer);
                if (Object.keys(store).length === 0) {
                    container.innerHTML = `<div style="padding: 3rem; text-align: center; color: var(--text-secondary);"><div style="font-size: 3rem; margin-bottom: 1rem;">üéØ</div><h3>No Savings Plans Yet</h3><p style="margin-top: 0.5rem;">Create your first savings goal to start tracking your progress!</p></div>`;
                    return;
                }
                let html = '';
                Object.entries(store).forEach(([id, plan]) => {
                    const currentAmount = plan.currentAmount || 0, targetAmount = plan.targetAmount || 1;
                    const progress = Math.min((currentAmount / targetAmount) * 100, 100);
                    const remaining = Math.max(targetAmount - currentAmount, 0);
                    let projectionText = '';
                    if (plan.targetDate && remaining > 0) {
                        const today = new Date(), targetDate = new Date(plan.targetDate);
                        const daysRemaining = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
                        if (daysRemaining > 0) {
                            const avgContribution = this.calculateAverageContribution(plan);
                            if (avgContribution > 0) {
                                const daysNeeded = Math.ceil(remaining / avgContribution);
                                const projectedDate = new Date(today); projectedDate.setDate(projectedDate.getDate() + daysNeeded);
                                if (projectedDate <= targetDate) { projectionText = `<div style="color: var(--success-color); font-size: 0.875rem; margin-top: 0.5rem;">‚úì On track to reach goal by ${projectedDate.toLocaleDateString()}</div>`; }
                                else { const neededPerDay = (remaining / daysRemaining).toFixed(2); projectionText = `<div style="color: var(--warning-color); font-size: 0.875rem; margin-top: 0.5rem;">‚ö† Need ${this.formatCurrency(neededPerDay)}/day to reach goal on time</div>`; }
                            }
                        } else if (daysRemaining < 0) { projectionText = `<div style="color: var(--danger-color); font-size: 0.875rem; margin-top: 0.5rem;">Target date passed</div>`; }
                    }
                    const categoryIcons = { emergency: 'üö®', vacation: '‚úàÔ∏è', purchase: 'üõçÔ∏è', education: 'üéì', retirement: 'üèñÔ∏è', other: 'üí∞' };
                    html += `
                        <div class="savings-plan-card">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">${categoryIcons[plan.category] || 'üí∞'} ${plan.name}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">${plan.category.charAt(0).toUpperCase() + plan.category.slice(1)}${plan.targetDate ? ' ‚Ä¢ Target: ' + new Date(plan.targetDate).toLocaleDateString() : ''}</div>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="app.showSavingsDetail('${id}')">Details</button>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div><div style="font-size: 0.75rem; color: var(--text-secondary);">Current</div><div style="font-size: 1.5rem; font-weight: 700; color: var(--success-color);">${this.formatCurrency(currentAmount)}</div></div>
                                <div><div style="font-size: 0.75rem; color: var(--text-secondary);">Target</div><div style="font-size: 1.5rem; font-weight: 700;">${this.formatCurrency(targetAmount)}</div></div>
                            </div>
                            <div class="savings-progress-bar"><div class="savings-progress-fill" style="width: ${progress}%">${progress.toFixed(1)}%</div></div>
                            <div style="display: flex; justify-content: space-between; margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                                <span>Remaining: ${this.formatCurrency(remaining)}</span><span>${plan.transactions ? plan.transactions.length : 0} transactions</span>
                            </div>
                            ${projectionText}
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button class="btn btn-sm btn-success" onclick="app.showAddContribution('${id}')">+ Deposit</button>
                                <button class="btn btn-sm btn-warning" onclick="app.showAddWithdrawal('${id}')">- Withdraw</button>
                            </div>
                        </div>`;
                });
                container.innerHTML = html;
            },
            calculateAverageContribution(plan) {
                if (!plan.transactions || plan.transactions.length === 0) return 0;
                const deposits = plan.transactions.filter(t => t.type === 'deposit');
                if (deposits.length === 0) return 0;
                const sortedDeposits = deposits.sort((a, b) => new Date(a.date) - new Date(b.date));
                const firstDate = new Date(sortedDeposits[0].date), lastDate = new Date(sortedDeposits[sortedDeposits.length - 1].date);
                const daysBetween = Math.max((lastDate - firstDate) / (1000 * 60 * 60 * 24), 1);
                const totalDeposited = deposits.reduce((sum, t) => sum + t.amount, 0);
                return totalDeposited / daysBetween;
            },
            showCreateSavingsPlan() {
                this._tempSavings.editingPlan = null;
                document.getElementById('savingsPlanModalTitle').textContent = 'Create Savings Plan';
                document.getElementById('savingsPlanName').value = '';
                document.getElementById('savingsPlanTarget').value = '';
                document.getElementById('savingsPlanDate').value = '';
                document.getElementById('savingsPlanCategory').value = 'emergency';
                document.getElementById('savingsPlanModal').classList.add('active');
            },
            closeSavingsPlanModal() { document.getElementById('savingsPlanModal').classList.remove('active'); },
            saveSavingsPlan() {
                const store = this.getActiveSavingsStore();
                const name = document.getElementById('savingsPlanName').value.trim();
                const target = parseFloat(document.getElementById('savingsPlanTarget').value);
                const targetDate = document.getElementById('savingsPlanDate').value;
                const category = document.getElementById('savingsPlanCategory').value;
                if (!name) { alert('Please enter a goal name'); return; }
                if (!target || target <= 0) { alert('Please enter a valid target amount'); return; }
                const planId = this._tempSavings.editingPlan || `savings_${Date.now()}`;
                store[planId] = {
                    id: planId, name: name, targetAmount: target,
                    currentAmount: store[planId]?.currentAmount || 0,
                    targetDate: targetDate || null, category: category,
                    createdDate: store[planId]?.createdDate || new Date().toISOString(),
                    transactions: store[planId]?.transactions || []
                };
                this.closeSavingsPlanModal();
                this.saveData();
                this.renderSavingsPlans();
            },
            showAddContribution(planId) {
                this._tempSavings.currentPlanId = planId;
                this._tempSavings.transactionType = 'deposit';
                document.getElementById('savingsTransactionTitle').textContent = 'Add Deposit';
                document.getElementById('savingsTransactionAmount').value = '';
                document.getElementById('savingsTransactionDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('savingsTransactionNote').value = '';
                document.getElementById('savingsTransactionModal').classList.add('active');
            },
            showAddWithdrawal(planId) {
                this._tempSavings.currentPlanId = planId;
                this._tempSavings.transactionType = 'withdrawal';
                document.getElementById('savingsTransactionTitle').textContent = 'Add Withdrawal';
                document.getElementById('savingsTransactionAmount').value = '';
                document.getElementById('savingsTransactionDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('savingsTransactionNote').value = '';
                document.getElementById('savingsTransactionModal').classList.add('active');
            },
            closeSavingsTransactionModal() { document.getElementById('savingsTransactionModal').classList.remove('active'); },
            saveSavingsTransaction() {
                const store = this.getActiveSavingsStore();
                const amount = parseFloat(document.getElementById('savingsTransactionAmount').value);
                const date = document.getElementById('savingsTransactionDate').value;
                const note = document.getElementById('savingsTransactionNote').value.trim();
                if (!amount || amount <= 0) { alert('Please enter a valid amount'); return; }
                if (!date) { alert('Please select a date'); return; }
                const plan = store[this._tempSavings.currentPlanId];
                if (!plan) return;
                if (!plan.transactions) plan.transactions = [];
                const transaction = {
                    id: `transaction_${Date.now()}`, type: this._tempSavings.transactionType,
                    amount: amount, date: date, note: note, timestamp: new Date().toISOString()
                };
                plan.transactions.push(transaction);
                if (this._tempSavings.transactionType === 'deposit') {
                    plan.currentAmount = (plan.currentAmount || 0) + amount;
                } else {
                    plan.currentAmount = Math.max((plan.currentAmount || 0) - amount, 0);
                }
                this.closeSavingsTransactionModal();
                this.saveData();
                this.renderSavingsPlans();
                this.renderActiveView(); // Re-render all, as this may affect cash flow
            },
            showSavingsDetail(planId) {
                const store = this.getActiveSavingsStore();
                const plan = store[planId];
                if (!plan) return;
                this._tempSavings.currentPlanId = planId;
                document.getElementById('savingsDetailTitle').textContent = plan.name;
                const currentAmount = plan.currentAmount || 0, targetAmount = plan.targetAmount || 1;
                const progress = Math.min((currentAmount / targetAmount) * 100, 100), remaining = Math.max(targetAmount - currentAmount, 0);
                let transactionsHtml = '';
                if (plan.transactions && plan.transactions.length > 0) {
                    const sortedTransactions = plan.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    sortedTransactions.forEach(t => {
                        const isDeposit = t.type === 'deposit';
                        transactionsHtml += `
                            <div class="transaction-detail ${isDeposit ? 'income' : 'expense'}" style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600;">${isDeposit ? '‚ûï Deposit' : '‚ûñ Withdrawal'}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">${new Date(t.date).toLocaleDateString()} ${t.note ? ' ‚Ä¢ ' + t.note : ''}</div>
                                </div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: ${isDeposit ? 'var(--success-color)' : 'var(--danger-color)'};">${isDeposit ? '+' : '-'}${this.formatCurrency(t.amount)}</div>
                            </div>`;
                    });
                } else {
                    transactionsHtml = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">No transactions yet</div>';
                }
                const content = `
                    <div style="margin-bottom: 2rem;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: var(--background); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">Current</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success-color);">${this.formatCurrency(currentAmount)}</div>
                            </div>
                            <div style="background: var(--background); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">Target</div>
                                <div style="font-size: 1.5rem; font-weight: 700;">${this.formatCurrency(targetAmount)}</div>
                            </div>
                            <div style="background: var(--background); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">Remaining</div>
                                <div style="font-size: 1.5rem; font-weight: 700;">${this.formatCurrency(remaining)}</div>
                            </div>
                        </div>
                        <div class="savings-progress-bar" style="height: 32px;"><div class="savings-progress-fill" style="width: ${progress}%; font-size: 0.875rem;">${progress.toFixed(1)}%</div></div>
                        ${plan.targetDate ? `<div style="text-align: center; margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem;">Target Date: ${new Date(plan.targetDate).toLocaleDateString()}</div>` : ''}
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="font-size: 1.125rem; font-weight: 600;">Transaction History</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-success" onclick="app.showAddContribution('${planId}'); app.closeSavingsDetailModal();">+ Deposit</button>
                            <button class="btn btn-sm btn-warning" onclick="app.showAddWithdrawal('${planId}'); app.closeSavingsDetailModal();">- Withdraw</button>
                        </div>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">${transactionsHtml}</div>`;
                document.getElementById('savingsDetailContent').innerHTML = content;
                document.getElementById('savingsDetailModal').classList.add('active');
            },
            closeSavingsDetailModal() { document.getElementById('savingsDetailModal').classList.remove('active'); },
            deleteSavingsPlan() {
                if (confirm('Are you sure you want to delete this savings plan? This cannot be undone.')) {
                    const store = this.getActiveSavingsStore();
                    delete store[this._tempSavings.currentPlanId];
                    this.closeSavingsDetailModal();
                    this.saveData();
                    this.renderSavingsPlans();
                    this.renderActiveView();
                }
            },
            
            // ============ EVENT LISTENERS ============
            
            setupEventListeners() {
                // Setup sub-tab navigation for both views
                ['personal', 'combined'].forEach(view => {
                    const nav = document.getElementById(`${view}-sub-nav`);
                    nav.querySelectorAll('.sub-tab-button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            nav.querySelectorAll('.sub-tab-button').forEach(b => b.classList.remove('active'));
                            e.target.classList.add('active');
                            
                            const viewContainer = document.getElementById(`${view}-app-view`);
                            viewContainer.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
                            
                            const tabId = e.target.dataset.tab;
                            document.getElementById(`${view}-tab-${tabId}`).classList.add('active');
                            
                            // Re-render components for that tab if needed
                            this.renderActiveView(); 
                        });
                    });
                });

                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 's') { e.preventDefault(); this.saveData(); }
                });
                document.getElementById('fileInput').addEventListener('change', (e) => { this.handleFileImport(e.target.files); });
            }
        };

        // ============ APP INITIALIZATION ============
        
        function initializeApp() {
            if (typeof gapi !== 'undefined') {
                app.handleClientLoad();
            } else {
                setTimeout(initializeApp, 100);
            }
        }
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
