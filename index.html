<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Financial Calendar - Cloud Edition</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --background: #f9fafb;
            --surface: #ffffff;
            --border: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--surface);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-card {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
        }

        .auth-card h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .auth-card p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .app-header {
            background: var(--surface);
            border-bottom: 2px solid var(--border);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-email {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .sync-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: var(--success-color);
            color: white;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: var(--border); color: var(--text-primary); }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.75rem; }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        #googleSignInButton {
            margin: 1rem auto;
        }
    </style>
</head>
<body>
    <div id="authScreen" class="auth-screen">
        <div class="auth-card">
            <h1>üí∞ Financial Calendar</h1>
            <p>Secure cloud storage with Google Drive</p>
            
            <!-- Google Sign In Button will be rendered here -->
            <div id="googleSignInButton"></div>
            
            <div style="margin-top: 1.5rem; font-size: 0.75rem; color: var(--text-secondary); max-width: 350px;">
                <strong>Sign in with your test account:</strong><br>
                jiu.robinson@gmail.com or ripto40@gmail.com
            </div>
            
            <div id="authStatus"></div>
        </div>
    </div>

    <div class="app-container" id="mainApp" style="display: none;">
        <header class="app-header">
            <div>
                <div class="app-title">Personal Financial Calendar</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);" id="profileSubtitle">Loading...</div>
            </div>
            <div class="user-info">
                <span class="sync-status" id="syncStatus">‚òÅÔ∏è Ready</span>
                <span class="user-email" id="userEmail"></span>
                <button class="btn btn-sm btn-secondary" onclick="app.signOut()">Sign Out</button>
            </div>
        </header>

        <div style="padding: 2rem; text-align: center;">
            <h2>Welcome to Financial Calendar!</h2>
            <p style="margin-top: 1rem; color: var(--text-secondary);">
                You're successfully signed in. Your data will be saved to Google Drive.
            </p>
            <div style="margin-top: 2rem;">
                <button class="btn btn-primary" onclick="app.testDriveAccess()">Test Drive Connection</button>
            </div>
            <div id="driveTestResult" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '994220951699-f5k7j6fig37c6gb9d9igjb9jjqoio59q.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCeGRt1vaUNWc_ZMBsg26wR-wfSH8C3GKU';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];

        const app = {
            accessToken: null,
            userEmail: null,
            gapiInited: false,
            gisInited: false,
            tokenClient: null,

            initializeGoogleSignIn() {
                console.log('Initializing Google Identity Services...');
                
                // Initialize Google Identity Services (GIS) for OAuth
                try {
                    this.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: (response) => {
                            console.log('Token received:', response);
                            if (response.error) {
                                this.showStatus('Error: ' + response.error, 'error');
                                return;
                            }
                            this.accessToken = response.access_token;
                            this.handleSignIn();
                        },
                    });
                    
                    this.gisInited = true;
                    console.log('GIS initialized successfully');
                    this.renderSignInButton();
                } catch (error) {
                    console.error('Error initializing GIS:', error);
                    this.showStatus('Failed to initialize sign-in. Please refresh the page.', 'error');
                }
            },

            initializeGapi() {
                console.log('Initializing GAPI...');
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: API_KEY,
                            discoveryDocs: DISCOVERY_DOCS,
                        });
                        this.gapiInited = true;
                        console.log('GAPI initialized successfully');
                    } catch (error) {
                        console.error('Error initializing GAPI:', error);
                        this.showStatus('Failed to initialize Google API client.', 'error');
                    }
                });
            },

            renderSignInButton() {
                console.log('Rendering sign-in button...');
                const buttonDiv = document.getElementById('googleSignInButton');
                
                // Create a custom button
                buttonDiv.innerHTML = `
                    <button onclick="app.requestSignIn()" style="
                        background: white;
                        border: 1px solid #dadce0;
                        border-radius: 4px;
                        padding: 0.75rem 1.5rem;
                        font-size: 1rem;
                        cursor: pointer;
                        display: inline-flex;
                        align-items: center;
                        gap: 0.75rem;
                        transition: box-shadow 0.2s;
                    " onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)'" 
                       onmouseout="this.style.boxShadow='none'">
                        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg">
                            <g fill="none" fill-rule="evenodd">
                                <path d="M17.6 9.2l-.1-1.8H9v3.4h4.8C13.6 12 13 13 12 13.6v2.2h3a8.8 8.8 0 0 0 2.6-6.6z" fill="#4285F4"/>
                                <path d="M9 18c2.4 0 4.5-.8 6-2.2l-3-2.2a5.4 5.4 0 0 1-8-2.9H1V13a9 9 0 0 0 8 5z" fill="#34A853"/>
                                <path d="M4 10.7a5.4 5.4 0 0 1 0-3.4V5H1a9 9 0 0 0 0 8l3-2.3z" fill="#FBBC05"/>
                                <path d="M9 3.6c1.3 0 2.5.4 3.4 1.3L15 2.3A9 9 0 0 0 1 5l3 2.4a5.4 5.4 0 0 1 5-3.7z" fill="#EA4335"/>
                            </g>
                        </svg>
                        Sign in with Google
                    </button>
                `;
            },

            requestSignIn() {
                console.log('Requesting sign-in...');
                this.showStatus('Opening sign-in window...', 'info');
                
                if (!this.tokenClient) {
                    this.showStatus('Sign-in not ready. Please refresh the page.', 'error');
                    return;
                }

                // Request an access token
                this.tokenClient.requestAccessToken({
                    prompt: 'consent',
                });
            },

            async handleSignIn() {
                console.log('Handling sign-in...');
                this.showStatus('Signing in...', 'info');

                try {
                    // Get user info using the access token
                    const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to get user info');
                    }

                    const userInfo = await response.json();
                    this.userEmail = userInfo.email;
                    
                    console.log('Signed in as:', this.userEmail);
                    
                    // Set the access token for gapi client
                    gapi.client.setToken({
                        access_token: this.accessToken
                    });

                    this.showStatus('Successfully signed in!', 'success');
                    
                    // Show main app
                    setTimeout(() => {
                        document.getElementById('authScreen').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'flex';
                        document.getElementById('userEmail').textContent = this.userEmail;
                    }, 1000);

                } catch (error) {
                    console.error('Error during sign-in:', error);
                    this.showStatus('Sign-in failed: ' + error.message, 'error');
                }
            },

            signOut() {
                if (confirm('Sign out? Your data will remain in Google Drive.')) {
                    // Revoke the token
                    if (this.accessToken) {
                        google.accounts.oauth2.revoke(this.accessToken, () => {
                            console.log('Token revoked');
                        });
                    }
                    
                    this.accessToken = null;
                    this.userEmail = null;
                    gapi.client.setToken(null);
                    
                    document.getElementById('authScreen').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                    
                    this.showStatus('', '');
                }
            },

            async testDriveAccess() {
                const resultDiv = document.getElementById('driveTestResult');
                resultDiv.innerHTML = '<div class="spinner"></div>';

                try {
                    console.log('Testing Drive access...');
                    
                    // Try to list files
                    const response = await gapi.client.drive.files.list({
                        pageSize: 10,
                        fields: 'files(id, name)',
                    });

                    const files = response.result.files;
                    
                    resultDiv.innerHTML = `
                        <div class="status-message status-success">
                            ‚úÖ Drive connection successful!<br>
                            Found ${files.length} files in your Drive.
                        </div>
                    `;
                    
                    console.log('Drive files:', files);
                } catch (error) {
                    console.error('Error accessing Drive:', error);
                    resultDiv.innerHTML = `
                        <div class="status-message status-error">
                            ‚ùå Drive connection failed:<br>
                            ${error.message}
                        </div>
                    `;
                }
            },

            showStatus(message, type) {
                const statusDiv = document.getElementById('authStatus');
                if (!message) {
                    statusDiv.innerHTML = '';
                    return;
                }

                const className = type === 'error' ? 'status-error' : 
                                 type === 'success' ? 'status-success' : 
                                 'status-info';

                statusDiv.innerHTML = `<div class="status-message ${className}">${message}</div>`;
            },

            init() {
                console.log('App initializing...');
                console.log('Current URL:', window.location.href);
                
                // Wait for both GIS and GAPI to be ready
                const checkReady = setInterval(() => {
                    if (typeof google !== 'undefined' && typeof gapi !== 'undefined') {
                        clearInterval(checkReady);
                        console.log('Google libraries loaded');
                        this.initializeGoogleSignIn();
                        this.initializeGapi();
                    }
                }, 100);
            }
        };

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }
    </script>
</body>
</html>
