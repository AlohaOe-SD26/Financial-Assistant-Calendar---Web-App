<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Calendar - Complete</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2563eb; --success: #10b981; --danger: #ef4444;
            --warning: #f59e0b; --bg: #f9fafb; --surface: #fff; --border: #e5e7eb;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); }
        .auth-screen { display: flex; align-items: center; justify-content: center;
            min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .auth-card { background: white; padding: 3rem; border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; max-width: 400px; }
        .auth-card h1 { font-size: 2rem; margin-bottom: 1rem; color: var(--primary); }
        .app-container { max-width: 1400px; margin: 0 auto; background: var(--surface); min-height: 100vh; }
        .header { background: var(--surface); border-bottom: 2px solid var(--border);
            padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header h1 { color: var(--primary); font-size: 1.5rem; }
        .btn { padding: 0.625rem 1.25rem; border: none; border-radius: 6px; cursor: pointer;
            font-size: 0.875rem; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: var(--border); color: #111; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.75rem; }
        .tabs { display: flex; background: var(--surface); border-bottom: 2px solid var(--border); }
        .tab { flex: 1; padding: 1rem; border: none; background: transparent; cursor: pointer;
            border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; padding: 1.5rem; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem; }
        .form-control { width: 100%; padding: 0.625rem; border: 1px solid var(--border);
            border-radius: 6px; font-size: 0.875rem; }
        .form-control:focus { outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .modal.active { display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .modal-content { background: var(--surface); border-radius: 8px; max-width: 600px;
            width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--border);
            display: flex; gap: 0.75rem; justify-content: flex-end; }
        .item-card { background: var(--bg); padding: 1rem; border-radius: 8px;
            margin-bottom: 0.75rem; border-left: 4px solid var(--primary); }
        .item-card.income { border-left-color: var(--success); }
        .item-card.expense { border-left-color: var(--danger); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--bg); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border); }
        .stat-value { font-size: 2rem; font-weight: 700; margin: 0.5rem 0; }
        .stat-label { font-size: 0.875rem; color: #6b7280; }
        .spinner { border: 3px solid var(--border); border-top: 3px solid var(--primary);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .sync-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px;
            background: var(--success); color: white; }
    </style>
</head>
<body>
    <div id="authScreen" class="auth-screen">
        <div class="auth-card">
            <h1>üí∞ Financial Calendar</h1>
            <p style="color: #6b7280; margin-bottom: 2rem;">Secure cloud storage with Google Drive</p>
            <div id="googleSignInButton"></div>
            <div style="margin-top: 1.5rem; font-size: 0.75rem; color: #6b7280;">
                Sign in with: jiu.robinson@gmail.com or ripto40@gmail.com
            </div>
            <div id="authStatus"></div>
        </div>
    </div>

    <div class="app-container" id="mainApp" style="display: none;">
        <header class="header">
            <h1>üí∞ Financial Calendar</h1>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span class="sync-badge" id="syncStatus">‚òÅÔ∏è Synced</span>
                <span style="font-size: 0.875rem; color: #6b7280;" id="userEmail"></span>
                <button class="btn btn-sm btn-secondary" onclick="app.signOut()">Sign Out</button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="app.switchTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="app.switchTab('transactions')">Transactions</button>
            <button class="tab" onclick="app.switchTab('reports')">Reports</button>
        </div>

        <div id="tab-dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Monthly Income</div>
                    <div class="stat-value text-success" id="monthlyIncome">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Monthly Expenses</div>
                    <div class="stat-value text-danger" id="monthlyExpenses">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Cash Flow</div>
                    <div class="stat-value" id="cashFlow">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Net Worth</div>
                    <div class="stat-value" id="netWorth">$0</div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="app.showAddModal('income')">+ Add Income</button>
            <button class="btn btn-success" onclick="app.showAddModal('expense')">+ Add Expense</button>
            <button class="btn btn-secondary" onclick="app.showAddModal('asset')">+ Add Asset</button>

            <div style="margin-top: 2rem;">
                <h2 style="margin-bottom: 1rem;">Recent Transactions</h2>
                <div id="recentTransactions"></div>
            </div>
        </div>

        <div id="tab-transactions" class="tab-content">
            <h2 style="margin-bottom: 1rem;">All Transactions</h2>
            <div id="allTransactions"></div>
        </div>

        <div id="tab-reports" class="tab-content">
            <h2 style="margin-bottom: 1rem;">Financial Reports</h2>
            <canvas id="reportChart" style="max-height: 400px;"></canvas>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Transaction</h2>
                <button style="background: none; border: none; font-size: 1.5rem; cursor: pointer;"
                        onclick="app.closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" id="itemName" class="form-control" placeholder="e.g., Salary, Rent">
                </div>
                <div class="form-group">
                    <label class="form-label">Amount ($)</label>
                    <input type="number" id="itemAmount" class="form-control" step="0.01" placeholder="0.00">
                </div>
                <div class="form-group" id="frequencyGroup">
                    <label class="form-label">Frequency</label>
                    <select id="itemFrequency" class="form-control">
                        <option value="monthly">Monthly</option>
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Bi-weekly</option>
                        <option value="daily">Daily</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="annually">Annually</option>
                    </select>
                </div>
                <div class="form-group" id="categoryGroup">
                    <label class="form-label">Category</label>
                    <select id="itemCategory" class="form-control">
                        <option value="housing">Housing</option>
                        <option value="food">Food</option>
                        <option value="transportation">Transportation</option>
                        <option value="utilities">Utilities</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group" id="startDateGroup">
                    <label class="form-label">Start Date</label>
                    <input type="date" id="itemStartDate" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveItem()">Save</button>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '994220951699-f5k7j6fig37c6gb9d9igjb9jjqoio59q.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCeGRt1vaUNWc_ZMBsg26wR-wfSH8C3GKU';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const DRIVE_FILE_NAME = 'financial_calendar_data.json';

        const app = {
            accessToken: null,
            userEmail: null,
            gapiInited: false,
            tokenClient: null,
            driveFileId: null,
            currentItemType: null,
            reportChart: null,

            // Data
            data: {
                profile: 'My Budget',
                assets: [],
                incomes: [],
                expenses: []
            },

            // Initialize
            async init() {
                console.log('Initializing app...');
                const checkReady = setInterval(() => {
                    if (typeof google !== 'undefined' && typeof gapi !== 'undefined') {
                        clearInterval(checkReady);
                        this.initGIS();
                        this.initGAPI();
                    }
                }, 100);
            },

            initGIS() {
                try {
                    this.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: (response) => {
                            if (response.error) {
                                this.showStatus('Error: ' + response.error, 'error');
                                return;
                            }
                            this.accessToken = response.access_token;
                            this.handleSignIn();
                        },
                    });
                    this.renderSignInButton();
                } catch (error) {
                    console.error('GIS init error:', error);
                }
            },

            async initGAPI() {
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: API_KEY,
                            discoveryDocs: DISCOVERY_DOCS,
                        });
                        await gapi.client.load('drive', 'v3');
                        this.gapiInited = true;
                        console.log('GAPI ready');
                    } catch (error) {
                        console.error('GAPI init error:', error);
                    }
                });
            },

            renderSignInButton() {
                document.getElementById('googleSignInButton').innerHTML = `
                    <button onclick="app.requestSignIn()" style="background: white; border: 1px solid #dadce0;
                        border-radius: 4px; padding: 0.75rem 1.5rem; font-size: 1rem; cursor: pointer;
                        display: inline-flex; align-items: center; gap: 0.75rem;">
                        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg">
                            <g fill="none"><path d="M17.6 9.2l-.1-1.8H9v3.4h4.8C13.6 12 13 13 12 13.6v2.2h3a8.8 8.8 0 0 0 2.6-6.6z" fill="#4285F4"/>
                            <path d="M9 18c2.4 0 4.5-.8 6-2.2l-3-2.2a5.4 5.4 0 0 1-8-2.9H1V13a9 9 0 0 0 8 5z" fill="#34A853"/>
                            <path d="M4 10.7a5.4 5.4 0 0 1 0-3.4V5H1a9 9 0 0 0 0 8l3-2.3z" fill="#FBBC05"/>
                            <path d="M9 3.6c1.3 0 2.5.4 3.4 1.3L15 2.3A9 9 0 0 0 1 5l3 2.4a5.4 5.4 0 0 1 5-3.7z" fill="#EA4335"/></g>
                        </svg>
                        Sign in with Google
                    </button>`;
            },

            requestSignIn() {
                this.showStatus('Opening sign-in...', 'info');
                this.tokenClient.requestAccessToken({ prompt: 'consent' });
            },

            async handleSignIn() {
                try {
                    const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                        headers: { 'Authorization': `Bearer ${this.accessToken}` }
                    });
                    const userInfo = await response.json();
                    this.userEmail = userInfo.email;
                    
                    gapi.client.setToken({ access_token: this.accessToken });
                    
                    document.getElementById('authScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('userEmail').textContent = this.userEmail;
                    
                    await this.loadFromDrive();
                    this.render();
                } catch (error) {
                    console.error('Sign-in error:', error);
                    this.showStatus('Sign-in failed: ' + error.message, 'error');
                }
            },

            signOut() {
                if (confirm('Sign out?')) {
                    if (this.accessToken) {
                        google.accounts.oauth2.revoke(this.accessToken);
                    }
                    this.accessToken = null;
                    this.userEmail = null;
                    gapi.client.setToken(null);
                    document.getElementById('authScreen').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                }
            },

            async loadFromDrive() {
                this.setSyncStatus('loading');
                try {
                    const response = await fetch(
                        `https://www.googleapis.com/drive/v3/files?q=name='${DRIVE_FILE_NAME}'&fields=files(id,name)`,
                        { headers: { 'Authorization': `Bearer ${this.accessToken}` } }
                    );
                    const result = await response.json();
                    
                    if (result.files && result.files.length > 0) {
                        this.driveFileId = result.files[0].id;
                        const fileResponse = await fetch(
                            `https://www.googleapis.com/drive/v3/files/${this.driveFileId}?alt=media`,
                            { headers: { 'Authorization': `Bearer ${this.accessToken}` } }
                        );
                        this.data = await fileResponse.json();
                    }
                    this.setSyncStatus('synced');
                } catch (error) {
                    console.error('Load error:', error);
                    this.setSyncStatus('error');
                }
            },

            async saveToDrive() {
                this.setSyncStatus('syncing');
                try {
                    const content = JSON.stringify(this.data, null, 2);
                    const blob = new Blob([content], { type: 'application/json' });
                    
                    if (this.driveFileId) {
                        await fetch(
                            `https://www.googleapis.com/upload/drive/v3/files/${this.driveFileId}?uploadType=media`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'Authorization': `Bearer ${this.accessToken}`,
                                    'Content-Type': 'application/json'
                                },
                                body: content
                            }
                        );
                    } else {
                        const metadata = { name: DRIVE_FILE_NAME, mimeType: 'application/json' };
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                        form.append('file', blob);
                        
                        const response = await fetch(
                            'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
                            {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${this.accessToken}` },
                                body: form
                            }
                        );
                        const result = await response.json();
                        this.driveFileId = result.id;
                    }
                    this.setSyncStatus('synced');
                } catch (error) {
                    console.error('Save error:', error);
                    this.setSyncStatus('error');
                }
            },

            setSyncStatus(status) {
                const el = document.getElementById('syncStatus');
                switch(status) {
                    case 'loading': el.textContent = '‚è≥ Loading...'; el.style.background = '#f59e0b'; break;
                    case 'syncing': el.textContent = '‚¨ÜÔ∏è Syncing...'; el.style.background = '#f59e0b'; break;
                    case 'synced': el.textContent = '‚òÅÔ∏è Synced'; el.style.background = '#10b981'; break;
                    case 'error': el.textContent = '‚ùå Error'; el.style.background = '#ef4444'; break;
                }
            },

            switchTab(tab) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById(`tab-${tab}`).classList.add('active');
                if (tab === 'reports') this.updateChart();
            },

            showAddModal(type) {
                this.currentItemType = type;
                document.getElementById('modalTitle').textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                document.getElementById('frequencyGroup').style.display = type === 'asset' ? 'none' : 'block';
                document.getElementById('categoryGroup').style.display = type === 'expense' ? 'block' : 'none';
                document.getElementById('startDateGroup').style.display = type !== 'asset' ? 'block' : 'none';
                document.getElementById('itemName').value = '';
                document.getElementById('itemAmount').value = '';
                document.getElementById('itemStartDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('addModal').classList.add('active');
            },

            closeModal() {
                document.getElementById('addModal').classList.remove('active');
            },

            async saveItem() {
                const item = {
                    id: Date.now(),
                    name: document.getElementById('itemName').value,
                    amount: parseFloat(document.getElementById('itemAmount').value) || 0,
                };
                
                if (this.currentItemType !== 'asset') {
                    item.frequency = document.getElementById('itemFrequency').value;
                    item.startDate = document.getElementById('itemStartDate').value;
                }
                
                if (this.currentItemType === 'expense') {
                    item.category = document.getElementById('itemCategory').value;
                }
                
                if (this.currentItemType === 'asset') {
                    item.value = item.amount;
                    item.category = 'cash';
                    this.data.assets.push(item);
                } else if (this.currentItemType === 'income') {
                    this.data.incomes.push(item);
                } else {
                    this.data.expenses.push(item);
                }
                
                await this.saveToDrive();
                this.closeModal();
                this.render();
            },

            formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
            },

            normalizeToMonthly(amount, frequency) {
                const factors = { daily: 30.4375, weekly: 4.3333, biweekly: 2.1666, monthly: 1, quarterly: 1/3, annually: 1/12 };
                return amount * (factors[frequency] || 1);
            },

            render() {
                let monthlyIncome = 0;
                this.data.incomes.forEach(i => monthlyIncome += this.normalizeToMonthly(i.amount, i.frequency));
                
                let monthlyExpenses = 0;
                this.data.expenses.forEach(e => monthlyExpenses += this.normalizeToMonthly(e.amount, e.frequency));
                
                let netWorth = 0;
                this.data.assets.forEach(a => netWorth += a.value || 0);
                
                const cashFlow = monthlyIncome - monthlyExpenses;
                
                document.getElementById('monthlyIncome').textContent = this.formatCurrency(monthlyIncome);
                document.getElementById('monthlyExpenses').textContent = this.formatCurrency(monthlyExpenses);
                document.getElementById('cashFlow').textContent = this.formatCurrency(cashFlow);
                document.getElementById('cashFlow').className = 'stat-value ' + (cashFlow >= 0 ? 'text-success' : 'text-danger');
                document.getElementById('netWorth').textContent = this.formatCurrency(netWorth);
                
                this.renderTransactions();
            },

            renderTransactions() {
                const recent = document.getElementById('recentTransactions');
                const all = document.getElementById('allTransactions');
                
                let html = '';
                [...this.data.incomes, ...this.data.expenses].slice(-10).reverse().forEach(item => {
                    const isIncome = this.data.incomes.includes(item);
                    html += `
                        <div class="item-card ${isIncome ? 'income' : 'expense'}">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${item.name}</strong>
                                    <div style="font-size: 0.875rem; color: #6b7280;">${item.frequency || ''}</div>
                                </div>
                                <div style="font-size: 1.125rem; font-weight: 600;">
                                    ${isIncome ? '+' : '-'}${this.formatCurrency(item.amount)}
                                </div>
                            </div>
                        </div>`;
                });
                
                recent.innerHTML = html || '<p style="color: #6b7280;">No transactions yet. Add your first income or expense!</p>';
                all.innerHTML = html || '<p style="color: #6b7280;">No transactions yet.</p>';
            },

            updateChart() {
                const ctx = document.getElementById('reportChart').getContext('2d');
                if (this.reportChart) this.reportChart.destroy();
                
                let monthlyIncome = 0;
                this.data.incomes.forEach(i => monthlyIncome += this.normalizeToMonthly(i.amount, i.frequency));
                
                let monthlyExpenses = 0;
                this.data.expenses.forEach(e => monthlyExpenses += this.normalizeToMonthly(e.amount, e.frequency));
                
                this.reportChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Monthly Income', 'Monthly Expenses', 'Net Cash Flow'],
                        datasets: [{
                            label: 'Amount ($)',
                            data: [monthlyIncome, monthlyExpenses, monthlyIncome - monthlyExpenses],
                            backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)',
                                monthlyIncome - monthlyExpenses >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { ticks: { callback: v => '$' + v.toLocaleString() } } }
                    }
                });
            },

            showStatus(message, type) {
                const div = document.getElementById('authStatus');
                if (!message) { div.innerHTML = ''; return; }
                const colors = { error: '#fee2e2', success: '#d1fae5', info: '#dbeafe' };
                div.innerHTML = `<div style="margin-top: 1rem; padding: 1rem; background: ${colors[type] || colors.info};
                    border-radius: 8px; font-size: 0.875rem;">${message}</div>`;
            }
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }
    </script>
</body>
</html>
